!function(e,t){"use strict";"function"==typeof define&&define.amd?define(["jquery"],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t(require("jquery")):e.enxHelper=t(e.jQuery)}(this,function(u){var e=new function(){var h=this;this.GlobalVar=new function(){this.XMLTAG="<\\?xml.*\\?>",this.ExceptionNode="#text",this.IllegalTagEnd="/>",this.LawfulTagEnd="></parameter>",this.LinkTag="link>",this.LinkTagReplace="linkC>",this.UserDefineField=[],this.SpaceCount=2,this.FormatTpl=new function(){this.Paratemter="<parameter{0}/>",this.Link="<link>{0}</link>",this.CDATA="<![CDATA[{0}]]>"},this.ElemntIndex=new function(){this.Link=1,this.Ne=1,this.Board=1,this.SubBoard=1,this.Port=1,this.Tester=1,this.Dev=1,this.Atm=1,this.Eth=1,this.Sdh=1,this.Sftp=1,this.Agent=1,this.VM=1,this.Network=1},this.DeaultElemntIndex=new function(){this.Link=1,this.Ne=1,this.Board=1,this.SubBoard=1,this.Port=1,this.Tester=1,this.Dev=1,this.Atm=1,this.Eth=1,this.Sdh=1,this.Sftp=1,this.Agent=1,this.VM=1,this.Network=1}},this.Field={ID:"_id",BigType:"BigType",ParentGID:"ParentGID",IsTopDevice:"IsTopDevice",Name:"Name"},this.SpecialField={IP:"ip"},this.ModelType={Env:"Env",Ne:"Ne",Board:"Board",SubBoard:"SubBoard",Port:"Port",Link:"Link",Topolimit:"Topolimit",Tester:"Tester",Dev:"Dev",Atm:"Atm",Eth:"Eth",Sdh:"Sdh",Network:"Network",Sftp:"Sftp",Agent:"Agent",VM:"VM",Other:"Other"},this.ModelTypeOfTopDevice=[this.ModelType.Ne,this.ModelType.Atm,this.ModelType.Tester,this.ModelType.Dev,this.ModelType.Eth,this.ModelType.Sdh,this.ModelType.Network,this.ModelType.Sftp,this.ModelType.Agent],this.ResetMaxIndex=function(e,t){var n=t.match(new RegExp("0|[1-9]\\d*","gm"));n&&0<n.length&&this.GlobalVar.ElemntIndex[e]<=parseInt(n[n.length-1])&&(this.GlobalVar.ElemntIndex[e]=parseInt(n[n.length-1])+1)},this.PreDealEnxContent=function(e){return e.replace(new RegExp(this.GlobalVar.XMLTAG,"gm"),"").replace(new RegExp(h.GlobalVar.IllegalTagEnd,"gm"),h.GlobalVar.LawfulTagEnd).replace(new RegExp(h.GlobalVar.LinkTag,"gm"),h.GlobalVar.LinkTagReplace)},this.EnxToLstJson=function(e){var a=this;this.GlobalVar.ElemntIndex=this.GlobalVar.DeaultElemntIndex;var l=[];if(!e)return l;var t=this.PreDealEnxContent(e),n=u(t)[0],s={};s[E.RootNodeAttr]=h.GetNodeAttr(n);var r=h.GetChildNode(n);return u.each(r,function(e,t){switch(t.tagName){case E.NodeName.ENXFILE_NODE_PARAMETERS:var n=h.ParameterNodeToJson(t);s=c.CombineJson(n,s),l.push(s);break;case E.NodeName.ENXFILE_NODE_DEVICES:var r=h.GetChildNode(t);u(r).each(function(e,t){var n=h.DeviceNodeToJson(t,s,!0);l=l.concat(n)});break;case E.NodeName.ENXFILE_NODE_LINKS:var o=h.GetChildNode(t);u(o).each(function(e,t){var n=h.LinkNodeToJson(t);n&&n.objname&&n.objname.value&&(n[h.Field.ParentGID]=c.GetStrValue(s,h.Field.ID),l.push(n),a.ResetMaxIndex(h.ModelType.Link,n.objname.value))});break;case E.NodeName.ENXFILE_NODE_TOPOLIMIT:var i={};i[h.Field.BigType]=h.ModelType.Topolimit,i[h.Field.ParentGID]=c.GetStrValue(s,h.Field.ID),i[h.Field.Name]=h.MatchTopLimit(u.trim(t.innerHTML)),i[h.Field.ID]=h.CreateNewGuid(),l.push(i)}}),l},this.LstJsonToEnx=function(e){if(!e||0==e.length)return"";var t=u(E.XMLTAG.LOGIC_ENVIRONMENT),n=c.GetJsonByKey(e,h.Field.BigType,h.ModelType.Env);c.IsJsonObj(n)&&!c.IsEmptyJson(n)&&n||(n=h.ParameterNodeToJson(null));var r=n[E.RootNodeAttr];for(var o in r)t.attr(o,c.GetStrValue(r,o));var i=u(E.XMLTAG.PARAMETERSTAG);i[0].innerText=h.XmlGetParameter(n,!0),t.append(i),h.XMLJsonToNode(n,t,e);var a=u(E.XMLTAG.LINKS),l=c.FilterListByValues(e,h.Field.BigType,[h.ModelType.Link]),s="";u.each(l,function(e,t){s+=h.Format(h.GlobalVar.FormatTpl.Link,h.XmlGetParameter(t))}),a[0].innerText=s,t.append(a);var p=c.GetJsonByKey(e,h.Field.BigType,h.ModelType.Topolimit),d=u(E.XMLTAG.TOPOLIMIT);return d[0].innerText=h.Format(h.GlobalVar.FormatTpl.CDATA,p[h.Field.Name]||""),t.append(d),t[0].outerHTML},this.XmlGetParameter=function(e,t){0==this.GlobalVar.UserDefineField.length&&(this.GlobalVar.UserDefineField=c.GetJsonAllValue(h.Field),this.GlobalVar.UserDefineField.push(E.RootNodeAttr));var n="";for(var r in e)if(this.GlobalVar.UserDefineField.indexOf(r)<0){var o=e[r],i="";for(var a in o)i+=" "+a+'="'+this.DealSpecialSingal(o[a])+'"';n+=h.Format(h.GlobalVar.FormatTpl.Paratemter,i)}return n},this.DealSpecialSingal=function(e){return null!=e&&null!=e&&e&&(-1<e.indexOf('"')&&(e=e.replace(new RegExp('"',"gm"),"★")),-1<e.indexOf("&")&&(e=e.replace(new RegExp("&","gm"),"♣")),-1<e.indexOf("<")&&(e=e.replace(new RegExp("<","gm"),"◀")),-1<e.indexOf(">")&&(e=e.replace(new RegExp(">","gm"),"▶"))),e},this.XMLJsonToNode=function(e,t,i){var n,r=c.GetStrValue(e,h.Field.ID);if((n=e.BigType==h.ModelType.Env?c.FilterListByValues(i,h.Field.IsTopDevice,[E.BoolStr.Yes]):c.FilterListByValues(i,h.Field.ParentGID,[r]))&&0<n.length){var a=u(E.XMLTAG.DEVICES);u.each(n,function(e,t){var n=u(E.XMLTAG.DEVICE),r=u(E.XMLTAG.PARAMETERSTAG),o=h.XmlGetParameter(t);r[0].innerText=o,n.append(r),h.XMLJsonToNode(t,n,i),a.append(n)}),t.append(a)}},this.GetUserDefineField=function(){},this.LinkNodeToJson=function(e){var r={},t=h.GetChildNode(e);return u.each(t,function(e,t){var n=u(t).attr(E.AttrName.ENXFILE_ATTR_NAME);n&&(r[h.Field.BigType]=h.ModelType.Link,r[n]=h.GetNodeAttr(t))}),this.NodeAttachFieldId(r),r},this.NodeAttachFieldId=function(e){var t=c.GetJsonValue(e,E.AttrName.ENXFILE_ATTR_GUID),n=c.GetStrValue(t,E.AttrName.ENXFILE_ATTR_VALUE)||h.CreateNewGuid();e[h.Field.ID]=n},this.ParameterNodeToJson=function(e){var r={};r[h.Field.BigType]=h.ModelType.Env;var t=h.GetChildNode(e);return u.each(t,function(e,t){var n=u(t).attr(E.AttrName.ENXFILE_ATTR_NAME);r[n]=h.GetNodeAttr(t)}),this.NodeAttachFieldId(r),r},this.DeviceNodeToJson=function(e,t,n){var r=[],o={};o[h.Field.ParentGID]=t[h.Field.ID]||"",o[h.Field.IsTopDevice]=n?E.BoolStr.Yes:E.BoolStr.No;var i=[],a=h.GetChildNode(e);return u.each(a,function(e,t){var n=t.tagName,r=h.GetChildNode(t);switch(n){case E.NodeName.ENXFILE_NODE_DEVICES:u.each(r,function(e,t){var n=h.DeviceNodeToJson(t,o);i=i.concat(n)});break;case E.NodeName.ENXFILE_NODE_PARAMETERS:u.each(r,function(e,t){var n=u(t).attr(E.AttrName.ENXFILE_ATTR_NAME);if(n==E.AttrName.ENXFILE_ATTR_CLASS){var r=u(t).attr(E.AttrName.ENXFILE_ATTR_VALUE);o[h.Field.BigType]=h.GetDeviceType(r)}o[n]=h.GetNodeAttr(t)}),o.objname.value,h.NodeAttachFieldId(o)}}),o.objname&&(this.ResetMaxIndex(o[h.Field.BigType],o.objname.value),r.push(o),r=r.concat(i)),r},this.MatchTopLimit=function(e){return e.replace("\x3c!--[CDATA[","").replace("]]--\x3e","")},this.GetDeviceType=function(e){var t="";switch(e){case E.SpecialName.ENXFILE_SPECIAL_TESTERTYPE:t=h.ModelType.Tester;break;case E.SpecialName.ENXFILE_SPECIAL_DEVTYPE:t=h.ModelType.Dev;break;case E.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPEATM:t=h.ModelType.Atm;break;case E.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPEETH:t=h.ModelType.Eth;break;case E.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPESDH:t=h.ModelType.Sdh;break;default:t=e}return t},this.GetNodeAttr=function(e){var t=e.attributes,n=u.makeArray(t);n.sort(function(e,t){return E.AttrDic[e.name]-E.AttrDic[t.name]});var r={};return u.each(n,function(e,t){r[t.name]=t.value}),r},this.CreateNewGuid=function(){for(var e="",t=1;t<=32;t++)e+=Math.floor(16*Math.random()).toString(16),8!=t&&12!=t&&16!=t&&20!=t||(e+="-");return e},this.Format=function(n,e){return 1==arguments.length?function(){var e=u.makeArray(arguments);return e.unshift(n),h.Format.apply(this,e)}:(2<arguments.length&&e.constructor!=Array&&(e=u.makeArray(arguments).slice(1)),e.constructor!=Array&&(e=[e]),u.each(e,function(e,t){n=n.replace(new RegExp("\\{"+e+"\\}","g"),t)}),n)},this.GetChildNode=function(e){var n=[];return e&&e.childNodes&&u.each(e.childNodes,function(e,t){t.nodeName!=h.GlobalVar.ExceptionNode&&n.push(t)}),n},this.GetQueryString=function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),n=window.location.search.substr(1).match(t);return null!=n?unescape(n[2]):null},this.AttrParameter=function(e,t){var n={};return n[E.AttrName.ENXFILE_ATTR_NAME]=e,n[E.AttrName.ENXFILE_ATTR_VALUE]=t||"",n}},E=new function(){this.RootNodeAttr="rootNodeAttr",this.NodeName={ENXFILE_NODE_DEVICES:"DEVICES",ENXFILE_NODE_LINKS:"LINKS",ENXFILE_NODE_TOPOLIMIT:"TOPOLIMIT",ENXFILE_NODE_LINK:"LINK",ENXFILE_NODE_DEVICE:"DEVICE",ENXFILE_NODE_PARAMETER:"PARAMETER",ENXFILE_NODE_PARAMETERS:"PARAMETERS"},this.AttrName={ENXFILE_ATTR_NAME:"name",ENXFILE_ATTR_OBJNAME:"objname",ENXFILE_ATTR_VALUE:"value",ENXFILE_ATTR_GROUPSHOW:"groupshow",ENXFILE_ATTR_CLASS:"class",ENXFILE_ATTR_SOURCETOPDEVICENAME:"sourcetopdevicename",ENXFILE_ATTR_TARGETTOPDEVICENAME:"targettopdevicename",ENXFILE_ATTR_SOURCEDEVICEID:"sourcedeviceid",ENXFILE_ATTR_TARGETDEVICEID:"targetdeviceid",ENXFILE_ATTR_GUID:"guid",ENXFILE_ATTR_ROLER:"roler",ENXFILE_ATTR_CLASS:"class",ENXFILE_ATTR_FULLCLASS:"fullclass",ENXFILE_ATTR_POSITION:"position",ENXFILE_ATTR_INTERFACE:"interface"},this.SpecialName={ENXFILE_SPECIAL_TESTERTYPE:"Instru::Tester",ENXFILE_SPECIAL_DEVTYPE:"Instru::Dev",ENXFILE_SPECIAL_UNKOWNTYPEETH:"Instru::Eth::Chassis",ENXFILE_SPECIAL_UNKOWNTYPEATM:"Instru::Atm::Chassis",ENXFILE_SPECIAL_UNKOWNTYPESDH:"Instru::Sdh",ENXFILE_SPECIAL_UNKOWNTYPECONNECT:"Connect"},this.XMLTAG=new function(){this.LOGIC_ENVIRONMENT="<logic_environment></logic_environment>",this.PARAMETERSTAG="<parameters></parameters>",this.DEVICES="<devices></devices>",this.LINKS="<links></links>",this.TOPOLIMIT="<topolimit></topolimit>",this.DEVICE="<device></device>",this.LINK="<link></link>",this.PARAMETER="<parameter/>"},this.AttrDic={name:10,value:11,notnull:12,visible:13,readonly:14,description:15,version:16},this.BoolStr={Yes:"yes",No:"no"},this.NameSeparate="_",this.NamePoint="to",this.ClassSeparate="::"},c=new function(){this.SetJsonByKey=function(e,t,n,r,o){if(e&&0<e.length)for(var i=0;i<e.length;i++){var a=e[i];this.IsContainKey(r,a[t])?a[n]=o[r[a[t]].toString()]:a[n]=o.default}return{}},this.GetJsonByKey=function(e,t,n){var r={};if(e&&0<e.length)for(var o=0;o<e.length;o++){var i=e[o];if(i[t]==n){r=i;break}}return r},this.GetJsonByKeyAndSecondKey=function(e,t,n,r){var o={};if(e&&0<e.length)for(var i=0;i<e.length;i++){var a=e[i];if(a[t][n]==r){o=a;break}}return o},this.GetJsonKeyList=function(e){var t=[];for(var n in e)t.push(e[n]);return t},this.ParseJsonToArr=function(e){var t=[];for(var n in e){var r={Name:n,Value:e[n]};t.push(r)}return t},this.GetJsonAllValue=function(e){var t=[];for(var n in e)t.push(e[n]);return t},this.GetJsonAllKey=function(e){var t=[];for(var n in e)t.push(n);return t},this.CopyJson=function(e){var t={};if(e){var n=u.toJSON(e);t=this.strJsonToJsonObj(n)}return t},this.IsEmptyJson=function(e){var t=!0;if(e)for(var n in e)if(!(t=!1))break;return t},this.IsContainKey=function(e,t){var n=!1;if(e)for(var r in e)if(r==t){n=!0;break}return n},this.ParseArrStrToArrJson=function(e){var n=[];return e&&0<e.length&&u(e).each(function(e,t){n.push(JSON.parse(t))}),n},this.IsArrStrContain=function(e,t){var n=!1;if(e&&0<e.length)for(var r=0;r<e.length;r++)if(e[r]==t){n=!0;break}return n},this.strJsonToJsonObj=function(e){return new Function("return "+e)()},this.GetListValueByKey=function(e,n){var r=[];return e&&0<e.length&&u(e).each(function(e,t){r.push(t[n])}),r},this.GetListValueByKey2=function(e,n,r){var o=[];return e&&0<e.length&&u(e).each(function(e,t){o.push(c.GetJsonValue(c.GetJsonValue(t,n),r))}),o},this.JsonArrUpdate=function(e,n,r){var o=this,i=[];return e&&0<e.length&&u(e).each(function(e,t){t[n]==r[n]?i.push(o.CombineJson(t,r)):i.push(t)}),i},this.JsonArrBatchUpdate=function(e,o,i,a,l){var s=[];return e&&0<e.length&&u(e).each(function(e,t){var n=t[o];if(-1<a.indexOf(n))for(var r in l)t[r][i]=l[r];s.push(t)}),s},this.JsonArrSingleUpdate=function(e,t,n,r,o,i){var a={},l={};if(e&&0<e.length)for(var s=0;s<e.length;s++){var p=e[s];if(r==p[t]){for(var d in l=JSON.parse(JSON.stringify(p)),o)p[d]||(p[d]={name:d,value:o[d]}),p[d][n]=o[d],d==E.AttrName.ENXFILE_ATTR_OBJNAME&&(p[E.AttrName.ENXFILE_ATTR_NAME][n]=o[d]);a=p;break}}return i&&i(l,a),a},this.JsonArrSingleUpdate2=function(e,t,n,r,o){if(e&&0<e.length)for(var i=0;i<e.length;i++){var a=e[i];if(r==a[t][n]){for(var l in o)a[l][n]=o[l];break}}},this.JsonArrDelete=function(e,n,r){var o=[];return e&&0<e.length&&u(e).each(function(e,t){t[n]!=r&&o.push(t)}),o},this.CombineJson=function(e,t){var n=e;if(t)for(var r in t)n[r]=t[r];return n},this.FilterListByValues=function(e,r,o){var i=[];return e&&0<e.length&&u(e).each(function(e,t){for(var n=0;n<o.length;n++)if(t[r]==o[n]){i.push(t);break}}),i},this.ExceptListByValues=function(e,o,i){var a=[];return e&&0<e.length&&u(e).each(function(e,t){for(var n=!1,r=0;r<i.length;r++)if(t[o]==i[r]){n=!0;break}n||a.push(t)}),a},this.CopyArr=function(e){var n=this,r=[];return e&&0<e.length&&u(e).each(function(e,t){r.push(n.strJsonToJsonObj(u.toJSON(t)))}),r},this.GetListValueByDoubleKey=function(e,r,o){var i=[];return e&&0<e.length&&u(e).each(function(e,t){var n=t[r]||{};i.push(n[o]||"")}),i},this.FilterArr=function(e,t,n){var r=[],o=t||"";if(e&&0<e.length)for(var i=0;i<e.length;i++){var a=e[i],l=!1;switch(n){case 0:l=0==a.indexOf(o);break;case 1:l=a.length-o.length==a.lastIndexOf(o);break;case 2:l=o==a}l&&r.push(a)}return r},this.StrArrToJsonList=function(e,t,n){var r=[];if(e&&0<e.length)for(var o=0;o<e.length;o++){var i=e[o],a={};a[t]=i,a[n]=i,r.push(a)}return r},this.Distinct=function(e){for(var t=[],n={},r=0;r<e.length;r++)n[e[r]]||(t.push(e[r]),n[e[r]]=1);return t},this.ArrDelete=function(e,n){var r=[];return e&&0<e.length&&u(e).each(function(e,t){t!=n&&r.push(t)}),r},this.ArrAdd=function(e,t){var n=[];return n.push(t),e&&0<e.length&&(0<=e.indexOf(t)||e.push(t),n=e),n},this.ArrJsonPaged=function(e,t,n,r){var o=[],i=n||0,a=t||0,l=i?i*a:0;if(e.length>l)for(var s=e.length-l,p=a<s?a:s,d=0;d<p;d++)o.push(e[l+d]);return o},this.JsonArrFilterByJson=function(e,a,l,t){var s=t||0,p=[];return e&&0<e.length&&u(e).each(function(e,t){var n=!0;for(var r in l){var o=c.GetJsonValue(t,r),i=l[r];if("object"==typeof o&&(o=c.GetJsonValue(o,a)),i instanceof Array&&0<i.length)n=n&&-1<i.indexOf(o);else switch(s){case 0:n=n&&0==o.indexOf(i);break;case 1:n=n&&o==i;break;case 2:n=n&&o.length-i.length==o.lastIndexOf(i);break;case 3:n=n&&0<=o.indexOf(i)}if(!n)break}n&&p.push(t)}),p},this.GetStrValue=function(e,t){return e[t]||""},this.GetJsonValue=function(e,t){return e[t]||{}},this.IsJsonObj=function(e){return"object"==typeof e&&"[object object]"==Object.prototype.toString.call(e).toLowerCase()&&!e.length}};return{enxHelper:e,enxConstField:E,jsonHelper:c}}),function(e,t){"use strict";"function"==typeof define&&define.amd?define(["jquery","enxHelper"],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t(require("jquery"),require("enxHelper")):e.envEditor=t(e.jQuery,e.enxHelper)}(this,function(m,T){var i="undefined"!=typeof window?window.document:{},a={root:"static/plugins/envEditor/",imageDir:"images/",dataDir:"data/",enxId:null};function n(){var c=this;this.Property=new function(){this.ERRCODE_SUCCESS="0x0000",this.DataList=[],this.LstNodeJson=[],this.LstLinkJson=[],this.BusyPortId=[],this.LstPortJson=[],this.ElementId="",this.Element={},this.SelectModelType=T.enxHelper.ModelType.Ne,this.CurrentUser="",this.DefaultPDU="SYSTEM",this.CurrentPDU=this.DefaultPDU,this.WebsvcSuffix=".asmx",this.FileAfter=".enx",this.EnxId=T.enxHelper.CreateNewGuid(),this.PostUrl=new function(){this.GetById="",this.UpdateById=""},this.GraphPlug={},this.TopoNode={},this.NetworkJson=[],this.SelectOptionValues={vmFlag:["","Fenix_GTR_4U4G100G_01","Fenix_vNE_sFTP_Tester_8U8G90G_01"],network:["","Base1","Base2","Fabric1","Fabric2","OM","External1","External2","External3","External4","External5","External6","ExternalN"],internal_external:["","InternalPort","ExternalPort"],virtual_real:["Virtual","Real"]},this.FileName="",this.ArrTestBedName=[]},this.SetData=function(e){this.ConstInfo.Reset(),this.Property.DataList=e,this.Property.TopoNode=T.jsonHelper.GetJsonByKey(e,T.enxHelper.Field.BigType,T.enxHelper.ModelType.Env),this.Property.LstNodeJson=T.jsonHelper.FilterListByValues(e,T.enxHelper.Field.IsTopDevice,[T.enxConstField.BoolStr.Yes]),this.Property.LstLinkJson=T.jsonHelper.FilterListByValues(e,T.enxHelper.Field.BigType,[T.enxHelper.ModelType.Link]),c.Property.BusyPortId=[],m.each(c.Property.LstLinkJson,function(e,t){var n=T.jsonHelper.GetStrValue(t[T.enxConstField.AttrName.ENXFILE_ATTR_SOURCEDEVICEID],T.enxConstField.AttrName.ENXFILE_ATTR_VALUE),r=T.jsonHelper.GetStrValue(t[T.enxConstField.AttrName.ENXFILE_ATTR_TARGETDEVICEID],T.enxConstField.AttrName.ENXFILE_ATTR_VALUE);c.Property.BusyPortId.push(n),c.Property.BusyPortId.push(r)}),this.Property.LstPortJson=T.jsonHelper.FilterListByValues(e,T.enxHelper.Field.BigType,[T.enxHelper.ModelType.Port]),this.GraphEditor.Init()},this.GetObjectNameCache=function(){var o={};return c.Property.DataList&&0<c.Property.DataList.length&&m(c.Property.DataList).each(function(e,t){var n=T.jsonHelper.GetJsonValue(T.jsonHelper.GetJsonValue(t,T.enxConstField.AttrName.ENXFILE_ATTR_OBJNAME),T.enxConstField.AttrName.ENXFILE_ATTR_VALUE),r=t[T.enxHelper.Field.ID];o[n]=r}),o},this.Init=function(e){var t=T.enxHelper.GetQueryString(c.ConstInfo.QueryStringParam.pdu),n=T.enxHelper.GetQueryString(c.ConstInfo.QueryStringParam.user),r=T.enxHelper.GetQueryString(c.ConstInfo.QueryStringParam.enxId);c.Property.CurrentPDU=t||c.Property.DefaultPDU;var o=c.PduRelUrl[c.Property.CurrentPDU]||c.PduRelUrl[c.Property.DefaultPDU];-1==o.indexOf(c.Property.WebsvcSuffix)?(c.Property.PostUrl.GetById=o+c.ConstInfo.QueryMethod.GetEnvContentByIdNew,c.Property.PostUrl.UpdateById=o+c.ConstInfo.QueryMethod.UpdateDataByIdNew):(c.Property.PostUrl.GetById=o+c.ConstInfo.QueryMethod.GetEnxContentById,c.Property.PostUrl.UpdateById=o+c.ConstInfo.QueryMethod.UpdateDataById),n&&(c.Property.CurrentUser=n),r&&(c.Property.EnxId=r,this.GetEnxContentByID(r)),m(i.body).addClass("envEditor"),this.OptionParam=m.extend({},a,e),c.SetData([]),this.loadLocalEnx()},this.loadLocalEnx=function(){var e=m(".EplugGraphEditorRightContainer"),t=this.OptionParam;e.showLoader(),m.get(t.root+t.dataDir+t.enxId+".enx",function(e){c.SetData(T.enxHelper.EnxToLstJson(e))}).always(function(){e.hideLoader()})},this.toggleRightContainer=function(e){var i=m(".EplugGraphRightToggle"),a=m(".EplugGraphEditorResource"),l=m(".EplugGraphEditorRightContainer"),s=m(".EplugGraphEditorRightTop"),t=i.outerWidth(),p=560-t,n=i.hasClass("left"),r=function(e,t,n,r,o){l.css({"padding-right":r+p}),a.css("width",e),s.css("display",o),i[t]("left").attr("title",n)};e?n&&r(560,"removeClass","Close","+=","block"):n||r(t,"addClass","Open","-=","none")},this.GetEnxContentByID=function(e){var o=[],i="",t=c.Property.CurrentUser,n="GET",r="";-1==c.Property.PostUrl.GetById.indexOf(c.Property.WebsvcSuffix)?c.Property.PostUrl.GetById=T.enxHelper.Format(c.Property.PostUrl.GetById,e):(n="POST",r=JSON.stringify({user:t,enxId:e}));var a=c.Property.PostUrl.GetById,l=r,s=JSON.stringify({"X-Auth-UserID":t}),p=m(".EplugGraphEditorRightContainer");p.showLoader(),this.RequestService(n,a,l,s,function(e){p.hideLoader();var t="";if(e&&e.resMessage&&e.errcode==c.Property.ERRCODE_SUCCESS){var n=JSON.parse(e.resMessage);if(-1==c.Property.PostUrl.GetById.indexOf(c.Property.WebsvcSuffix))n&&n.content&&(i=n.content,c.Property.FileName=n.filename,m("#txtTopoLimit").val(n.topolimit));else if(n&&n.d){var r=JSON.parse(n.d).result;r&&(i=r.enx,c.Property.FileName=r.filename)}}else t=e.errcode;t&&toastr.error(t),i&&(o=T.enxHelper.EnxToLstJson(i))},function(e,t,n){p.hideLoader();var r=e.statusText;-1==c.Property.PostUrl.GetById.indexOf(c.Property.WebsvcSuffix)&&e.responseText&&(r=r+"\r\n"+(JSON.parse(e.responseText||"{}").message||"")),toastr.error(r)},function(e){c.SetData(o)})},this.GetEnxContent=function(){m.each(c.Property.LstNodeJson,function(e,t){var n=t[T.enxHelper.Field.ID],r=t[T.enxHelper.Field.BigType],o=c.Property.GraphPlug.GetCellsByFieldValue(r,c.Property.GraphPlug.ConstInfo.AttrName.ID,n),i=T.enxHelper.AttrParameter(T.enxConstField.AttrName.ENXFILE_ATTR_POSITION,c.Property.GraphPlug.Translater.BondToString(o));t[T.enxConstField.AttrName.ENXFILE_ATTR_POSITION]=i});var e=T.enxHelper.LstJsonToEnx(c.Property.DataList);return e.replace(new RegExp("&lt;","gm"),"<").replace(new RegExp("&gt;","gm"),">").replace(new RegExp("★","gm"),"&quot;").replace(new RegExp("♣","gm"),"&amp;").replace(new RegExp("◀","gm"),"&lt;").replace(new RegExp("▶","gm"),"&gt;")},this.GetPostData=function(){var e=this.GetEnxContent(),t=c.Property.CurrentUser,n=m("#txtTopoLimit").val(),r={},o=c.Property.FileName?c.Property.FileName:c.Property.EnxId+c.Property.FileAfter;if(-1==c.Property.PostUrl.UpdateById.indexOf(c.Property.WebsvcSuffix))r={id:c.Property.EnxId,content:e,filename:o,userid:t,topolimit:n,testbedname:"",testbedcontent:""};else{var i=c.Property.GraphPlug.GetImageUrl();r={user:c.Property.CurrentUser,enxId:c.Property.EnxId,enxContent:e,enxImageUrl:i,fileName:o}}return r},this.SaveData=function(o){var e=c.Property.PostUrl.UpdateById,t=this.GetPostData();if(t&&t.content){var n={"X-Auth-UserID":c.Property.CurrentUser};this.RequestService("POST",e,JSON.stringify(t),JSON.stringify(n),function(e){var t="";if(e&&e.resMessage&&e.errcode==c.Property.ERRCODE_SUCCESS){var n=JSON.parse(e.resMessage);if(-1==c.Property.PostUrl.UpdateById.indexOf(c.Property.WebsvcSuffix))n.result&&"success"==n.result?(c.OpenNewUrl(),o&&toastr.success("Save successfully!")):t=n.message;else{var r=JSON.parse(n.d);r.errcode&&(t=r.errcode)}}else t=e.errcode;o&&t&&toastr.error(t)},function(e,t,n){var r=e.statusText;-1==c.Property.PostUrl.UpdateById.indexOf(c.Property.WebsvcSuffix)&&e.responseText&&(r=r+"\r\n"+(JSON.parse(e.responseText||"{}").message||"")),o&&alertMsg&&toastr.error(r)})}},this.RequestService=function(e,t,n,r,o,i,a){var l=new FormData;l.append("req_type",e),l.append("service_addr",t),l.append("req_content",escape(n)),l.append("headerSet",escape(r)),m.ajax({type:"POST",url:"/Home/RequestService",data:l,dataType:"json",processData:!1,contentType:!1,success:o,error:i,complete:a})},this.ExportFile=function(){xmlContent=this.GetEnxContent();var e=new FormData;e.append("user",c.Property.CurrentUser),e.append("enxId",c.Property.EnxId),e.append("enxContent",escape(xmlContent)),m.ajax({type:"POST",url:"/Home/ExportEnxFile",data:e,dataType:"json",processData:!1,contentType:!1,success:function(e){e&&e.url&&c.OpenNewPage(e.url,void 0,!0),e&&e.errcode&&toastr.error(e.errcode)}})},this.ViewText=function(){xmlContent=this.GetEnxContent();var e=new FormData;e.append("enxId",c.Property.EnxId),e.append("enxContent",escape(xmlContent)),m.ajax({type:"POST",url:"/Home/ViewText",data:e,dataType:"json",processData:!1,contentType:!1,success:function(e){e&&m("#xmpViewText").text(e.content||e.errcode),m("#modalViewText").modal()}})},this.OpenNewPage=function(e,t,n){null!=t&&"object"==typeof t&&(e=e+"?"+m.param(t));var r="_blank";if(null!=n&&(r="_parent"),m.browser&&m.browser.mozilla)window.location=e;else{var o=i.createElement("a");o.href=e,o.target=r,o.style.display="none",i.body.appendChild(o),o.click(),i.body.removeChild(o)}},this.OpenNewUrl=function(){var e=c.Property.EnxId,t=(window.location.host,window.location.search.substr(1)),n=[],r=c.ConstInfo.QueryStringParam.enxId,o=r+"="+e;if(t){if(n=t.split("&"),t.indexOf(r)<0)n.push(o);else for(var i=0;i<n.length;i++)if(0<=n[i].indexOf(r)){n[i]=o;break}o=n.join("&")}window.location.search=o},this.GetElement=function(e){return this.Property.Element.find(e)},this.HtmlEditor=new function(){this.GetModelField=function(e,t){var n=c.ConstInfo.AvailableFiled[e];return c.ConstInfo.IsFirstInitAvailField[e]&&!t?this.InitAvailField(e):n},this.InitAvailField=function(e){var t=this.GetModelUnAvailField(e),n=this.GetModelField(e,!0),r=this.GetFirstModelEntity(e),o=T.jsonHelper.GetJsonAllValue(T.enxHelper.Field);c.ConstInfo.IsFirstInitAvailField[e]=!1;var i,a=T.jsonHelper.IsJsonObj(r);for(var l in r)"string"==typeof(i=a?l:r[l])&&o.indexOf(i)<0&&t.indexOf(i)<0&&n.push(i);return n},this.GetFirstModelEntity=function(e){return c.ConstInfo.DefaultAvailField[e]},this.GetModelUnAvailField=function(e){return c.ConstInfo.UnAvailableFiled[e]}},this.GraphEditor=new function(){this.Init=function(){T.jsonHelper.IsEmptyJson(c.Property.GraphPlug)?c.Property.GraphPlug=new e(c):(c.Property.GraphPlug.ClearChildren(),c.Property.GraphPlug.RenderData())}},this.OptionParam={},this.PduRelUrl={SYSTEM:"http://superlab.huawei.com:7996/",SYSTEM_TEST:"http://localhost:50038/"},this.GetSpecialField=function(e){var t=[];return e==T.enxHelper.ModelType.Link&&(t=T.jsonHelper.GetJsonAllKey(c.ConstInfo.SpecialFieldDic)),t},this.GetDisplayFieldName=function(e){var t=e;return c.ConstInfo.SpecialFieldDic[e]&&(t=c.ConstInfo.SpecialFieldDic[e]),t},this.ConstInfo=new function(){this.Reset=function(){this.IsFirstInitAvailField.Ne=!0,this.IsFirstInitAvailField.Tester=!0,this.IsFirstInitAvailField.Dev=!0,this.IsFirstInitAvailField.Atm=!0,this.IsFirstInitAvailField.Sdh=!0,this.IsFirstInitAvailField.Eth=!0,this.IsFirstInitAvailField.Board=!0,this.IsFirstInitAvailField.SubBoard=!0,this.IsFirstInitAvailField.Link=!0,this.IsFirstInitAvailField.Port=!0,this.IsFirstInitAvailField.Network=!0,this.IsFirstInitAvailField.Sftp=!0,this.IsFirstInitAvailField.Agent=!0,this.IsFirstInitAvailField.VM=!0,this.AvailableFiled.Ne=["roler"],this.Sdh=[],this.Atm=[],this.Eth=[],this.Tester=[],this.Dev=[],this.AvailableFiled.Board=[],this.AvailableFiled.SubBoard=[],this.AvailableFiled.Link=[],this.AvailableFiled.Port=[],this.Network=[],this.Sftp=[],this.Agent=[],this.AvailableFiled.VM=[]},this.REG_IP=new RegExp(/^((25[0-5]|2[0-4]\d|[01]?\d\d?)($|(?!\.$)\.)){4}$/),this.IPINPUTCLASS="EplugIpInput",this.IPINPUTINCORRECTCLASS="EplugIpInputIncorrect",this.IPINPUTINCORRECTTIP="Incorrect:",this.TableDataCheckId="data-checkIds",this.IDSelectorSingal="#",this.ClassSelectorSingal=".",this.IsFirstInitAvailField=new function(){this.Ne=!0,this.Sdh=!0,this.Atm=!0,this.Eth=!0,this.Tester=!0,this.Dev=!0,this.Board=!0,this.SubBoard=!0,this.Link=!0,this.Port=!0,this.Network=!0,this.Sftp=!0,this.Agent=!0,this.VM=!0},this.AvailableFiled=new function(){this.Ne=["roler"],this.Sdh=[],this.Atm=[],this.Eth=[],this.Tester=[],this.Dev=[],this.Board=[],this.SubBoard=[],this.Link=[],this.Port=[],this.Network=[],this.Sftp=[],this.Agent=[],this.VM=[]},this.DefaultAvailField=new function(){this.CommonAvailField=["objname","name","ip","type","version","alias","caption","is_topo","remark"],this.Ne=this.CommonAvailField.concat(["id","console","mask","username","password","ptp","vender","virtual_real","port","cmts_port","cmts_type","olt_version","sub_ip"]),this.Atm=this.CommonAvailField,this.Sdh=this.CommonAvailField,this.Eth=this.CommonAvailField.concat(["actor","bid","sbid","pid","connect_type","engrossstate","groupip","id","mac","username","password","port","portnum","ptp","realNEId","realtype","submask","vender"]),this.Board=this.CommonAvailField.concat(["angle","bid","engrossstate","username","password","portnum","realNEId","slot","virtual_real"]),this.SubBoard=this.CommonAvailField.concat(["bid","sbid","engrossstate","username","password","portnum","realNEId","submask","virtual_real"]),this.Link=this.CommonAvailField.concat(["sourcetopdevicename","sourcedeviceid","targettopdevicename","targetdeviceid","connect_type","direction","parent","cidr","start_ip","end_ip"]),this.Port=this.CommonAvailField.concat(["bid","sbid","pid","shape","submask","interface","host_id","internal_external","virtual_real"]),this.Network=this.CommonAvailField.concat(["cidr","start_ip","end_ip"]),this.VM=this.CommonAvailField.concat(["username","password","vmFlag","cpu_memory","hardDisk","mirror","virtual_real"]),this.Sftp=this.VM,this.Agent=this.VM,this.Tester=this.VM,this.Dev=this.VM},this.UnAvailableFiled=new function(){this.CommonUnAvailField=["name","guid","shape","position","class","fullclass"],this.Ne=this.CommonUnAvailField.concat(["id","bid","connect_type","mac","pid","port","portnum"]),this.Tester=this.CommonUnAvailField,this.Dev=this.CommonUnAvailField,this.Sdh=this.CommonUnAvailField,this.Atm=this.CommonUnAvailField,this.Eth=this.CommonUnAvailField,this.Board=this.CommonUnAvailField,this.SubBoard=this.CommonUnAvailField.concat(["bid"]),this.Link=this.CommonUnAvailField.concat(["dst_port","src_port"]),this.Port=this.CommonUnAvailField,this.Network=this.CommonUnAvailField,this.Sftp=this.CommonUnAvailField,this.Agent=this.CommonUnAvailField,this.VM=this.CommonUnAvailField},this.MinPageSize=10,this.CheckBoxTDFieldName="checkboxelem",this.OperationTDFieldName="operationelem",this.CombineRepalceSingal="(0*\\[[1-9]\\d*\\-[1-9]\\d*\\]|0*[1-9]\\d*\\+|0*\\*)(\\([1-9]\\d*\\))?",this.AllReplaceSingal="\\*",this.NumberRegionSingal="[1-9]\\d*",this.OccupiedPlace="0+",this.RegionReplaceSingal="\\[[1-9]\\d*\\-[1-9]\\d*\\]",this.NumAddSingal="+",this.NumAddReplaceSingal="[1-9]\\d*\\+",this.RegGM="gm",this.AddStep="(\\([1-9]\\d*\\))",this.AddSelfType={NumberAdd:"NumberAdd",Region:"Region",AutoAdd:"AutoAdd"},this.SpecialFieldDic={sourcedeviceid:"src_port",targetdeviceid:"dst_port"},this.SelectField=["vmFlag","network","internal_external","virtual_real"],this.NoEditField=["sourcetopdevicename","targettopdevicename"],this.NoEditTdClass="EPlugNoEditTd",this.QueryStringParam=new function(){this.pdu="pdu",this.user="user",this.enxId="enxId"},this.QueryMethod=new function(){this.GetEnxContentById="GetEnxContentById",this.GetEnvContentByIdNew="api/editor/v1/content/{0}",this.UpdateDataById="UpdateEnxContent",this.UpdateDataByIdNew="api/editor/v1/enx"},this.RepeatedSingal="(1)",this.RepeatedElemtClass="EPlugRepeatName",this.TIME_INTERVAL=null},this.SetNodeAttr=function(e,t,n,r){for(var o=this.GetLstByModelType(e),i=0;i<o.length;i++)if(o[i][T.enxHelper.Field.ID]==t){o[i][n]=r;break}},this.DeleteNodeAttr=function(e,t,n){for(var r=this.GetLstByModelType(e),o=0;o<r.length;o++)if(r[o][T.enxHelper.Field.ID]==t){delete r[o][n];break}},this.GetLstByModelType=function(e){var t=[];switch(e){case T.enxHelper.ModelType.Ne:t=c.Property.LstNodeJson;break;case T.enxHelper.ModelType.Link:t=c.Property.LstLinkJson;break;case T.enxHelper.ModelType.Port:t=c.Property.LstPortJson}return t},this.CreateModel=function(o,e,i,t,n,a){var l={};l[T.enxHelper.Field.BigType]=o,n||(n=T.enxHelper.CreateNewGuid()),l[T.enxHelper.Field.ID]=n,e&&(l[T.enxHelper.Field.ParentGID]=e);var r=T.enxHelper.AttrParameter(T.enxConstField.AttrName.ENXFILE_ATTR_GUID,n);l[T.enxConstField.AttrName.ENXFILE_ATTR_GUID]=r;var s=c.ConstInfo.DefaultAvailField[o],p=T.enxHelper.GlobalVar.ElemntIndex[o];if(s){var d=c.ConstInfo.SelectField;m.each(s,function(e,t){var n="";t!=T.enxConstField.AttrName.ENXFILE_ATTR_OBJNAME&&t!=T.enxConstField.AttrName.ENXFILE_ATTR_NAME||(n=c.Property.GraphPlug.ConstInfo.ElemntNamePre[o]+p,!i||o!=T.enxHelper.ModelType.Board&&o!=T.enxHelper.ModelType.SubBoard&&o!=T.enxHelper.ModelType.Port&&o!=T.enxHelper.ModelType.VM||(n=i+T.enxConstField.NameSeparate+n)),-1<d.indexOf(t)&&(n=c.Property.SelectOptionValues[t][0]),T.jsonHelper.IsJsonObj(a)&&a[t]&&(n=a[t]);var r=T.enxHelper.AttrParameter(t,n);l[t]=r})}T.enxHelper.GlobalVar.ElemntIndex[o]=p+1;var h=t?t+T.enxConstField.ClassSeparate:"";switch(o){case T.enxHelper.ModelType.Ne:case T.enxHelper.ModelType.Sftp:case T.enxHelper.ModelType.Agent:l[T.enxHelper.Field.IsTopDevice]=T.enxConstField.BoolStr.Yes,l[T.enxConstField.AttrName.ENXFILE_ATTR_CLASS]=T.enxHelper.AttrParameter(T.enxConstField.AttrName.ENXFILE_ATTR_CLASS,o),l[T.enxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=T.enxHelper.AttrParameter(T.enxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,o),c.Property.LstNodeJson.push(l);break;case T.enxHelper.ModelType.Network:l[T.enxHelper.Field.IsTopDevice]=e&&"Env"!=t?T.enxConstField.BoolStr.No:T.enxConstField.BoolStr.Yes,l[T.enxConstField.AttrName.ENXFILE_ATTR_CLASS]=T.enxHelper.AttrParameter(T.enxConstField.AttrName.ENXFILE_ATTR_CLASS,o),l[T.enxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=T.enxHelper.AttrParameter(T.enxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,o),c.Property.LstNodeJson.push(l);break;case T.enxHelper.ModelType.Tester:l[T.enxHelper.Field.IsTopDevice]=T.enxConstField.BoolStr.Yes,l[T.enxConstField.AttrName.ENXFILE_ATTR_CLASS]=T.enxHelper.AttrParameter(T.enxConstField.AttrName.ENXFILE_ATTR_CLASS,T.enxConstField.SpecialName.ENXFILE_SPECIAL_TESTERTYPE),l[T.enxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=T.enxHelper.AttrParameter(T.enxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,T.enxConstField.SpecialName.ENXFILE_SPECIAL_TESTERTYPE),c.Property.LstNodeJson.push(l);break;case T.enxHelper.ModelType.Dev:l[T.enxHelper.Field.IsTopDevice]=T.enxConstField.BoolStr.Yes,l[T.enxConstField.AttrName.ENXFILE_ATTR_CLASS]=T.enxHelper.AttrParameter(T.enxConstField.AttrName.ENXFILE_ATTR_CLASS,T.enxConstField.SpecialName.ENXFILE_SPECIAL_DEVTYPE),l[T.enxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=T.enxHelper.AttrParameter(T.enxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,T.enxConstField.SpecialName.ENXFILE_SPECIAL_DEVTYPE),c.Property.LstNodeJson.push(l);break;case T.enxHelper.ModelType.Atm:l[T.enxHelper.Field.IsTopDevice]=T.enxConstField.BoolStr.Yes,l[T.enxConstField.AttrName.ENXFILE_ATTR_CLASS]=T.enxHelper.AttrParameter(T.enxConstField.AttrName.ENXFILE_ATTR_CLASS,T.enxConstField.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPEATM),l[T.enxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=T.enxHelper.AttrParameter(T.enxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,T.enxConstField.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPEATM),c.Property.LstNodeJson.push(l);break;case T.enxHelper.ModelType.Sdh:l[T.enxHelper.Field.IsTopDevice]=T.enxConstField.BoolStr.Yes,l[T.enxConstField.AttrName.ENXFILE_ATTR_CLASS]=T.enxHelper.AttrParameter(T.enxConstField.AttrName.ENXFILE_ATTR_CLASS,T.enxConstField.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPESDH),l[T.enxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=T.enxHelper.AttrParameter(T.enxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,T.enxConstField.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPESDH),c.Property.LstNodeJson.push(l);break;case T.enxHelper.ModelType.Eth:l[T.enxHelper.Field.IsTopDevice]=T.enxConstField.BoolStr.Yes,l[T.enxConstField.AttrName.ENXFILE_ATTR_CLASS]=T.enxHelper.AttrParameter(T.enxConstField.AttrName.ENXFILE_ATTR_CLASS,T.enxConstField.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPEETH),l[T.enxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=T.enxHelper.AttrParameter(T.enxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,T.enxConstField.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPEETH),c.Property.LstNodeJson.push(l);break;case T.enxHelper.ModelType.Link:l[T.enxHelper.Field.IsTopDevice]=T.enxConstField.BoolStr.No,l[T.enxConstField.AttrName.ENXFILE_ATTR_CLASS]=T.enxHelper.AttrParameter(T.enxConstField.AttrName.ENXFILE_ATTR_CLASS,T.enxConstField.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPECONNECT),c.Property.LstLinkJson.push(l);break;case T.enxHelper.ModelType.Board:case T.enxHelper.ModelType.SubBoard:case T.enxHelper.ModelType.VM:l[T.enxHelper.Field.IsTopDevice]=T.enxConstField.BoolStr.No,l[T.enxConstField.AttrName.ENXFILE_ATTR_CLASS]=T.enxHelper.AttrParameter(T.enxConstField.AttrName.ENXFILE_ATTR_CLASS,o),l[T.enxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=T.enxHelper.AttrParameter(T.enxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,h+o);case T.enxHelper.ModelType.Port:l[T.enxHelper.Field.IsTopDevice]=T.enxConstField.BoolStr.No,l[T.enxConstField.AttrName.ENXFILE_ATTR_CLASS]=T.enxHelper.AttrParameter(T.enxConstField.AttrName.ENXFILE_ATTR_CLASS,o),l[T.enxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=T.enxHelper.AttrParameter(T.enxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,h+o),c.Property.LstPortJson.push(l)}return c.Property.DataList.push(l),l},this.CopyModel=function(e,t,r,o){var i=JSON.parse(JSON.stringify(e)),a=T.enxHelper.CreateNewGuid(),n=i[T.enxHelper.Field.ID];i[T.enxHelper.Field.ID]=a;var l=i[T.enxHelper.Field.BigType];t&&(i[T.enxHelper.Field.ParentGID]=t);var s=T.enxHelper.AttrParameter(T.enxConstField.AttrName.ENXFILE_ATTR_GUID,a);i[T.enxConstField.AttrName.ENXFILE_ATTR_GUID]=s;var p=[T.enxConstField.AttrName.ENXFILE_ATTR_OBJNAME,T.enxConstField.AttrName.ENXFILE_ATTR_NAME],d=T.enxHelper.GlobalVar.ElemntIndex[l],h=c.Property.GraphPlug.ConstInfo.ElemntNamePre[l]+d;switch(m.each(p,function(e,t){var n=h;!r||l!=T.enxHelper.ModelType.Board&&l!=T.enxHelper.ModelType.SubBoard&&l!=T.enxHelper.ModelType.Port&&l!=T.enxHelper.ModelType.VM||(n=r+T.enxConstField.NameSeparate+h),i[t][T.enxConstField.AttrName.ENXFILE_ATTR_VALUE]=n}),T.enxHelper.GlobalVar.ElemntIndex[l]=d+1,l){case T.enxHelper.ModelType.Ne:case T.enxHelper.ModelType.Tester:case T.enxHelper.ModelType.Dev:case T.enxHelper.ModelType.Atm:case T.enxHelper.ModelType.Sdh:case T.enxHelper.ModelType.Eth:c.Property.LstNodeJson.push(i);break;case T.enxHelper.ModelType.Link:c.Property.LstLinkJson.push(i);break;case T.enxHelper.ModelType.Port:c.Property.LstPortJson.push(i);break;default:c.Property.LstNodeJson.push(i)}c.Property.DataList.push(i);var u=T.jsonHelper.FilterListByValues(c.Property.DataList,T.enxHelper.Field.ParentGID,[n]),E=[i];return m.each(u,function(e,t){var n=c.CopyModel(t,a,h,o);E=E.concat(n)}),E},this.GetLinkByPortId=function(e){for(var t={},n=0;n<c.Property.LstLinkJson.length;n++){var r=c.Property.LstLinkJson[n];if(r.sourcedeviceid.value==e||r.targetdeviceid.value==e){t=r;break}}return t},this.RemoveModelByParentId=function(e,n){var t=this.RemoveModel(T.enxHelper.Field.ParentGID,e);n&&m.each(t,function(e,t){c.RemoveModelByParentId(t,n)})},this.RemoveModel=function(r,o){var i=[],a=[];return m.each(c.Property.DataList,function(e,t){var n=t[r];"object"==typeof n&&(n=T.jsonHelper.GetStrValue(n,T.enxConstField.AttrName.ENXFILE_ATTR_VALUE)),n!=o?i.push(t):(c.RemoveModelRelaHandler(t),a.push(T.jsonHelper.GetStrValue(t,T.enxHelper.Field.ID)))}),c.Property.DataList=i,a},this.RemoveModelRelaHandler=function(e){var t=e[T.enxHelper.Field.ID];switch(e[T.enxHelper.Field.BigType]){case T.enxHelper.ModelType.Ne:case T.enxHelper.ModelType.Tester:case T.enxHelper.ModelType.Dev:case T.enxHelper.ModelType.Atm:case T.enxHelper.ModelType.Sdh:case T.enxHelper.ModelType.Eth:c.Property.LstNodeJson=c.JsonArrDelete(c.Property.LstNodeJson,T.enxHelper.Field.ID,t);break;case T.enxHelper.ModelType.Link:c.Property.LstLinkJson=c.JsonArrDelete(c.Property.LstLinkJson,T.enxHelper.Field.ID,t);var n=T.jsonHelper.GetStrValue(e[T.enxConstField.AttrName.ENXFILE_ATTR_SOURCEDEVICEID],T.enxConstField.AttrName.ENXFILE_ATTR_VALUE),r=T.jsonHelper.GetStrValue(e[T.enxConstField.AttrName.ENXFILE_ATTR_TARGETDEVICEID],T.enxConstField.AttrName.ENXFILE_ATTR_VALUE);c.Property.BusyPortId.splice(c.Property.BusyPortId.indexOf(n),1),c.Property.BusyPortId.splice(c.Property.BusyPortId.indexOf(r),1);break;case T.enxHelper.ModelType.Port:if(c.Property.LstPortJson=c.JsonArrDelete(c.Property.LstPortJson,T.enxHelper.Field.ID,t),-1<c.Property.BusyPortId.indexOf(t)){var o=c.GetLinkByPortId(t);c.RemoveModel(T.enxHelper.Field.ID,T.jsonHelper.GetStrValue(o,T.enxHelper.Field.ID))}}},this.GetChildrens=function(r,o){var i=[];return m.each(c.Property.DataList,function(e,t){if(t[T.enxHelper.Field.ParentGID]==r&&(i.push(t),o)){var n=c.GetChildrens(t[T.enxHelper.Field.ID],o);i=i.concat(n)}}),i},this.JsonArrDelete=function(e,r,o){var i=[];return m.each(e,function(e,t){var n=t[r];"object"==typeof n&&(n=T.jsonHelper.GetStrValue(n,T.enxConstField.AttrName.ENXFILE_ATTR_VALUE)),n!=o&&i.push(t)}),i}}var e=function(E){var c=this,o=null;this.Property=new function(){this.CoreGraph={},this.Contain={},this.SelectedVertexId=[],this.SelectedLinkId=[],this.LinkGroupIndex=1,this.AssistantGraph={},this.Editor={}},this.Init=function(){if(mxClient.isBrowserSupported()){var e=this.Property.Contain=i.getElementById("EplugGraphEditorContainer"),t=this.Property.Editor=new mxEditor;(this.Property.CoreGraph=t.graph).init(e),this.BasicFixSet(),this.RenderData(),this.BindEventForMenu(),this.BindEvent(),this.InitPopMenu(),this.SubGraph.Init(),this.PropertyPanel.Init()}else mxUtils.error("Browser is not supported!",200,!1)},this.GroupLink=function(e){var t=this.GetAllLink(c.Property.CoreGraph),l=T.jsonHelper.FilterListByValues(t,this.ConstInfo.AttrName.ID,e),s=[];m.each(l,function(e,n){if(s.indexOf(n.id)<0){s.push(n.id);var r=n.source.id,o=n.target.id,i=[],a=n.group&&n.data.group.groupshow;m.each(l,function(e,t){t.id!=n.id&&(t.source.id==r&&t.target.id==o||t.target.id==r&&t.source.id==o)&&(a=a||t.group&&t.data.group.groupshow,i.push(t),s.push(t.id))}),a||c.CombineLinkToGroup(n,i,!1)}})},this.SubGraph=new function(){this.Graph={},this.Container={},this.EditGraphCell={};var d=this,r=null;function t(e,t){this.canSelectNode=null==e||e,this.canMoveVertet=null==t||t}this.Init=function(){d.Container=i.getElementById("EplugGraphEditorSubEditor"),d.Graph=new mxGraph(this.Container),d.BasicFixSet(),d.BindEvent(),d.ConfigureStylesheet(),d.InitPopMenu();var t=d.Graph.isCellMovable;d.Graph.isCellMovable=function(e){return t.apply(this,arguments)&&r.canMoveVertet};var n=d.Graph.isCellSelectable;d.Graph.isCellSelectable=function(e){return!(d.EditGraphCell&&d.EditGraphCell.edge&&!r.canSelectNode&&e.vertex)&&n.apply(this,arguments)}},this.BasicFixSet=function(){this.Graph.cellsResizable=!1,mxConstants.ENTITY_SEGMENT=20,this.Graph.cellsEditable=!1,this.Graph.edgeLabelsMovable=!1,this.Graph.allowDanglingEdges=!1,this.Graph.allowLoops=!1,this.Graph.setConnectable(!0),this.Graph.setDropEnabled(!0),this.Graph.setTooltips(!0),this.Graph.getTooltipForCell=function(e){return e.objname?e.objname:e.value},this.Graph.collapseToPreferredSize=!1,this.Graph.constrainChildren=!1,this.Graph.cellsSelectable=!0,this.Graph.extendParentsOnAdd=!1,this.Graph.extendParents=!1,this.Graph.border=10,this.Graph.keepEdgesInForeground=!0;var t=new mxStackLayout(this.Graph,!0);t.border=this.Graph.border,t.marginBottom=-10,new mxLayoutManager(this.Graph).getLayout=function(e){return e.collapsed?null:(e.parent!=d.Graph.model.root?(t.resizeParent=!0,t.horizontal=!1,t.spacing=10,t.x0=15):(t.resizeParent=!0,t.horizontal=!0,t.spacing=120,t.x0=0),t)},mxConstants.VERTEX_SELECTION_COLOR="#87CEEB",mxConstants.VERTEX_SELECTION_STROKEWIDTH=1.3,mxConstants.VERTEX_SELECTION_DASHED=!1,mxConstants.EDGE_SELECTION_STROKEWIDTH=1.3,mxConstants.HIGHLIGHT_STROKEWIDTH=1.3,mxEvent.disableContextMenu(this.Container),new mxCellTracker(this.Graph,"#87CEEB"),mxConstants.DROP_TARGET_COLOR="#87CEEB",mxConstants.CONNECT_HANDLE_FILLCOLOR="#87CEEB",mxConstants.HANDLE_STROKECOLOR="#87CEEB",mxRectangleShape.prototype.crisp=!0,mxGraphHandler.prototype.guidesEnabled=!0,mxGraph.prototype.expandedImage=null,mxGraph.prototype.collapsedImage=null,mxConnectionHandler.prototype.connectImage=new mxImage(c.GetImagePath("arrow.png"),20,20),this.Graph.htmlLabels=!0,this.Graph.getLabel=function(e){var t=this.labelsVisible?this.convertValueToString(e):"";if(e.vertex){var n=t.split("_");return'<div class="subgraph-item-label label-'+e.bigtype+" "+e.using+'" data-id="'+e.id+'">'+n[n.length-1]+"</div>"}return t}},this.ConfigureStylesheet=function(){var e={};e[mxConstants.STYLE_STROKECOLOR]=c.ConstInfo.LineDefualtColor,e[mxConstants.STYLE_STROKEWIDTH]=1.3,e[mxConstants.STYLE_FONTSTYLE]=2,e[mxConstants.STYLE_PERIMETER_SPACING]=0,e[mxConstants.STYLE_ENDARROW]="",e[mxConstants.STYLE_FONTCOLOR]="#5e698a",e[mxConstants.STYLE_FONTSIZE]=12,e[mxConstants.STYLE_VERTICAL_ALIGN]=mxConstants.ALIGN_BOTTOM,e[mxConstants.STYLE_EDGE]=mxConstants.EDGESTYLE_ENTITY_RELATION,e[mxConstants.STYLE_SEGMENT]=0,this.Graph.getStylesheet().putCellStyle(T.enxHelper.ModelType.Link,e)},this.SetPortStatus=function(e,t){d.Graph.getModel().beginUpdate();try{var n=t?c.ConstInfo.SwimStyle:c.ConstInfo.UsedPort;e&&(e.using=t?"":"using",d.Graph.getModel().setStyle(e,n),d.SetCellConnectable(e,t),this.EditGraphCell.vertex&&e.setConnectable(!1))}finally{d.Graph.getModel().endUpdate()}},this.SetLoopLinkPosition=function(e){d.Graph.getModel().beginUpdate();try{e.geometry.points||e.data.sourcetopdevicename.value!=e.data.targettopdevicename.value||(e.geometry.points=[new mxPoint(310,370)])}finally{d.Graph.getModel().endUpdate()}},this.ApplyPermission=function(e){r=e},this.SetNodeCannotMove=function(){this.ApplyPermission(new t(!1,!1))},this.ResetNodeMovable=function(){this.ApplyPermission(new t)},this.EditCell=function(e){d.ApplyPermission(new t),this.SetTopNav(e&&e.data),this.Graph.getModel().clear(),(this.EditGraphCell=e)&&e.vertex?this.RenderNe(e,!0,void 0,!1):e&&e.edge&&this.InitLinkEditor(e),d.ApplyPermission(new t(!0,!1))},this.SetTopNav=function(e){m(".EplugGraphEditorTopNav").css("display",e?"block":"none"),m(".EplugGraphEditorSubEditor").css("padding-top",e?191:130),m(".EplugGraphEditorTopElementName").attr("data-val",e&&e._id||"").text(e&&e.objname&&e.objname.value||"")},this.GetRootDeviceCellInfo=function(e){if(e&&e.data&&e.data.IsTopDevice==T.enxConstField.BoolStr.Yes&&e.bigtype==T.enxHelper.ModelType.Network)return e;var t=d.Graph.getModel().getParent(e);return!t||t.data&&t.data.IsTopDevice&&t.data.IsTopDevice==T.enxConstField.BoolStr.Yes?t:t=this.GetRootDeviceCellInfo(t)},this.ConnectHandler=mxUtils.bind(this,function(e,t){var n=t.properties.edge;if(!n.target)return!1;if(n.source.bigtype==T.enxHelper.ModelType.Network&&n.target.bigtype==T.enxHelper.ModelType.Network)return c.Property.CoreGraph.removeCells([n]),d.Graph.removeCells([n]),toastr.warning("No connection between the network!"),!1;n.style=T.enxHelper.ModelType.Link;var r=d.EditGraphCell.target.data[T.enxHelper.Field.ParentGID],o=E.CreateModel(T.enxHelper.ModelType.Link,r);o[T.enxConstField.AttrName.ENXFILE_ATTR_SOURCEDEVICEID][T.enxConstField.AttrName.ENXFILE_ATTR_VALUE]=n.source.id,o[T.enxConstField.AttrName.ENXFILE_ATTR_TARGETDEVICEID][T.enxConstField.AttrName.ENXFILE_ATTR_VALUE]=n.target.id,E.Property.BusyPortId.push(n.source.data.guid.value),E.Property.BusyPortId.push(n.target.data.guid.value),d.SetPortStatus(n.source,!1),d.SetPortStatus(n.target,!1);var i=d.GetRootDeviceCellInfo(n.source),a=d.GetRootDeviceCellInfo(n.target);if(n.source[d.ConstInfo.ROOTDEVICE]=i.data,n.target[d.ConstInfo.ROOTDEVICE]=a.data,o[T.enxConstField.AttrName.ENXFILE_ATTR_SOURCETOPDEVICENAME][T.enxConstField.AttrName.ENXFILE_ATTR_VALUE]=i.value,o[T.enxConstField.AttrName.ENXFILE_ATTR_TARGETTOPDEVICENAME][T.enxConstField.AttrName.ENXFILE_ATTR_VALUE]=a.value,c.AttachCell(n,o),d.Graph.getModel().setValue(n,o[T.enxConstField.AttrName.ENXFILE_ATTR_OBJNAME][T.enxConstField.AttrName.ENXFILE_ATTR_VALUE]),d.SetLoopLinkPosition(n),e.connectionHandler.select=!1,d.EditGraphCell.edge){var l=c.GetAllLink(d.Graph,void 0,!0);c.RenderVirtualLink(d.EditGraphCell.source,d.EditGraphCell.target,l)}}),this.InitPopMenu=function(){d.Graph.popupMenuHandler.factoryMethod=function(e,t,n){if(t){var r=d.Graph.getSelectionCells(),o=function(e,t){m(e).find("td:last").html('<span class="mxMenu-key">'+t+"</span>")};1==(r=0==r.length?[t]:r).length&&o(e.addItem("Edit",null,function(){c.PropertyPanel.EditNodeById(r[0].id)},null,"mxMenu edit"),"Enter"),o(e.addItem("Delete",null,function(){d.RemoveSelectCell(r)},null,"mxMenu delete"),"Del")}}},this.RemoveSelectCell=function(e){if(0!=(e=e||d.Graph.getSelectionCells()).length){m.each(e,function(e,t){d.RemoveCellRel(t),E.RemoveModelByParentId(t.id,!0),E.RemoveModel(T.enxHelper.Field.ID,t.id),E.Property.GraphPlug.RemoveCellById(t.bigtype,t.id)});var t=e[0];t&&t.vertex&&"yes"!=t.data.IsTopDevice&&c.Property.CoreGraph.fireEvent(new mxEventObject(mxEvent.CLICK,"event",null,"cell",d.EditGraphCell)),d.Graph.removeCells(e),0==d.Graph.getChildVertices().length&&d.SetTopNav()}},this.RemoveCellRel=function(e){if(e.edge)return d.SetPortStatus(e.target,!0),void d.SetPortStatus(e.source,!0);var t=[];if(e.bigtype==T.enxHelper.ModelType.Port&&-1<E.Property.BusyPortId.indexOf(e.id))t.push(e);else{var n=c.GetAllNode(d.Graph,e,!0);t=m.grep(n,function(e,t){return e.bigtype==T.enxHelper.ModelType.Port&&-1<E.Property.BusyPortId.indexOf(e.id)})}0!=t.length&&m.each(t,function(e,n){var t=m.grep(E.Property.LstLinkJson,function(e,t){return e.sourcedeviceid.value==n.id||e.targetdeviceid.value==n.id});if(t&&0!=t.length){var r=t[0]._id;c.RemoveCellById(T.enxHelper.ModelType.Link,r),E.RemoveModel(T.enxHelper.Field.ID,r)}})},this.InitLinkEditor=function(e){d.Graph.removeListener(d.ConnectHandler);var t,n=e.source,r=e.target;if(t=n.id!=r.id?2:1,this.RenderNe(n,!0,t,!0),n.id!=r.id){this.RenderNe(r,!0,t,!0);var o=d.Graph.getModel().getEdgesBetween(n,r,!1);d.CopyLinkFromCoreGraph(o)}else{var i=d.Graph.getModel().getEdgesBetween(n,n,!1);d.CopyLinkFromCoreGraph(i)}d.Graph.addListener(mxEvent.CELL_CONNECTED,d.ConnectHandler)},this.CopyLinkFromCoreGraph=function(e){if(e&&0<e.length){var s={},t=c.GetAllNode(d.Graph,void 0,!0);m.each(t,function(e,t){t.bigtype!=T.enxHelper.ModelType.Port&&t.bigtype!=T.enxHelper.ModelType.Network||(s[t.data.guid.value]=t)});var p=d.Graph.getDefaultParent();d.Graph.getModel().beginUpdate();try{m.each(e,function(e,t){var n=t.data;if(n){var r=n[T.enxConstField.AttrName.ENXFILE_ATTR_SOURCEDEVICEID][T.enxConstField.AttrName.ENXFILE_ATTR_VALUE],o=n[T.enxConstField.AttrName.ENXFILE_ATTR_TARGETDEVICEID][T.enxConstField.AttrName.ENXFILE_ATTR_VALUE],i=s[r],a=s[o];if(i&&a){d.SetCellConnectable(i,!1),d.SetCellConnectable(a,!1),i[d.ConstInfo.ROOTDEVICE]=t.source.data,a[d.ConstInfo.ROOTDEVICE]=t.target.data;var l=d.Graph.insertEdge(p,t.id,t.objname,s[r],s[o],T.enxHelper.ModelType.Link);c.AttachCell(l,t.data),d.SetLoopLinkPosition(l)}}})}finally{d.Graph.getModel().endUpdate()}}},this.SetCellConnectable=function(e,t){e&&e.bigtype!=T.enxHelper.ModelType.Network&&e.setConnectable(t)},this.RenderNe=function(e,t,n,r){var o={},i=d.Graph.getDefaultParent();d.Graph.getModel().beginUpdate();try{if(t){var a=T.jsonHelper.GetJsonByKey(E.Property.LstNodeJson,T.enxHelper.Field.ID,e.id),l=d.GetBond(a.BigType),s=c.Translater.JsonToCell(d.Graph,a,i,l,c.ConstInfo.SwimStyle);a.BigType==T.enxHelper.ModelType.Network?s.setConnectable(r):s.setConnectable(!1),o=s,-1<E.Property.BusyPortId.indexOf(a.guid.value)&&(s.setConnectable(!1),s.using="using")}else o=i;d.RenderChildCell(e,o,t,n,r)}finally{d.Graph.getModel().endUpdate()}},this.GetBond=function(e){var t=d.ConstInfo.ElementDeaultSet[e];return[0,0,t?t.Width:90,30]},this.RenderChildCell=function(e,i,a,l,s){var t=T.jsonHelper.GetStrValue(e,c.ConstInfo.AttrName.ID),n=T.jsonHelper.FilterListByValues(E.Property.DataList,T.enxHelper.Field.ParentGID,[t]);m.each(n,function(e,t){if(a&&t.BigType==T.enxHelper.ModelType.Port&&t.internal_external&&t.internal_external.value){var n=t.internal_external.value.toLowerCase().indexOf("external");if(1==l&&-1<n)return!0;if(2==l&&-1==n)return!0}var r=d.ConstInfo.ElementDeaultSet[t.BigType].Width,o=c.Translater.JsonToCell(d.Graph,t,i,[0,0,r,30],c.ConstInfo.SwimStyle,a);t.BigType==T.enxHelper.ModelType.Network?o.setConnectable(a&&s):o.setConnectable(t.BigType==T.enxHelper.ModelType.Port&&a&&s&&E.Property.BusyPortId.indexOf(t.guid.value)<0),-1<E.Property.BusyPortId.indexOf(t.guid.value)&&(d.Graph.getModel().setStyle(o,c.ConstInfo.UsedPort),o.using="using"),d.RenderChildCell(o,o,a,l,s)})},this.BindEvent=function(){d.Graph.addListener(mxEvent.CLICK,function(e,t){c.EditType=c.ConstInfo.EnumEditType.Element,t.properties.cell||c.PropertyPanel.Hide()}),m(".tools-delete").off("click").click(function(){d.RemoveSelectCell()})},this.ConstInfo=new function(){this.ElementDeaultSet=new function(){this.Ne={Width:200},this.Tester={Width:200},this.Dev={Width:200},this.Atm={Width:200},this.Sdh={Width:200},this.Eth={Width:200},this.Sftp={Width:200},this.Network={Width:105},this.Agent={Width:200},this.Board={Width:160},this.VM={Width:160},this.SubBoard={Width:140},this.Port={Width:90}},this.ROOTDEVICE="rootdevice"},this.InsertCell=function(e,t){var n=c.GetAllNode(d.Graph,null,!0),r=T.jsonHelper.GetJsonByKey(n,c.ConstInfo.AttrName.ID,t);T.jsonHelper.IsEmptyJson(r)||(c.SubGraph.ResetNodeMovable(),c.ExcuteDropInElement(d.Graph,r,e,[],c.ConstInfo.SwimStyle))}},this.ToggleToolBar=function(e){c.EditType==c.ConstInfo.EnumEditType.Topo?c.EditType=c.ConstInfo.EnumEditType.Element:c.EditType=c.ConstInfo.EnumEditType.Topo,m(".EplugGraphEditorElementItem").hide(),m(".EplugGraphEditorElementItem[data-edittype='"+c.EditType+"']").show(),m(".EplugGraphEditorElementItem[data-edittype='"+c.ConstInfo.EnumEditType.Network+"']").show(),m(".EplugGraphEditorTopMenu span").show(),m(".EplugGraphEditorTopMenu span[data-hidetype='"+c.EditType+"']").hide(),c.EditType!=c.ConstInfo.EnumEditType.Element||!e||e!=T.enxHelper.ModelType.Tester&&e!=T.enxHelper.ModelType.Dev&&e!=T.enxHelper.ModelType.Sftp&&e!=T.enxHelper.ModelType.Agent||(m(".EplugGraphEditorElementItem").hide(),m(".EplugGraphEditorElementItem[data-type='Port']").show())},this.PropertyPanel=new function(){var u=this;this.EditNodeJson={},this.CustomFields={},this.ElementId="EplugGraphEditorPropertyEditPanel",this.HtmlTemplate=new function(){this.FieldEditItem='<tr data-fieldname="{0}"><td class="EplugGraphEditorPropertyPanelFieldTitle EPlugTextEllipsis">{1}:</td><td><input value="{2}" type="text" class="field_value" /></td></tr>',this.FieldShowItem='<tr data-fieldname="{0}"><td class="EplugGraphEditorPropertyPanelFieldTitle EPlugTextEllipsis">{1}:</td><td><label class="EPlugTextEllipsis EplugGraphEditorPropertyPanelFieldLink" title="{3}" data-val="{2}">{3}</label></td></tr>',this.FieldEditSelItem='<tr data-fieldname="{0}"><td class="EplugGraphEditorPropertyPanelFieldTitle EPlugTextEllipsis">{1}:</td><td><select>{2}</select></td></tr>',this.SelectOptionItem='<option value="{0}" {2}>{1}</option>',this.FieldEditCustomItem='<tr class="custom_field" data-fieldname="{0}"><td><input type="text" class="custom_field_key" placeholder="Key" value="{0}" /><span>:</span></td><td><input type="text" class="custom_field_value field_value" placeholder="Value" value="{1}" /><span class="glyphicon glyphicon-plus custom_field_add" aria-hidden="true" title="Add"></span><span class="glyphicon glyphicon-minus custom_field_delete" aria-hidden="true" title="Delete"></span></td></tr>'},this.Init=function(){this.BindEvent()},this.GetElement=function(e){return m("#"+u.ElementId).find(e)},this.BindEvent=function(){u.GetElement(".EplugGraphEditorPropertyPanelTitleBtn").off("click").click(function(){u.Hide()}),m("#"+u.ElementId).off("change").on("change","input,select",function(){u.updateProperties()})},this.updateProperties=function(){var e=u.GetNodeJson();if(!T.jsonHelper.IsEmptyJson(e)){m.each(u.CustomFields,function(e,t){delete u.EditNodeJson[e]});var t=T.jsonHelper.JsonArrSingleUpdate(E.Property.DataList,T.enxHelper.Field.ID,T.enxConstField.AttrName.ENXFILE_ATTR_VALUE,u.EditNodeJson._id,e);E.Property.GraphPlug.UpdateCell(u.EditNodeJson.BigType,t)}},this.GetNodeJson=function(){var s={};return u.GetElement(".EplugGraphEditorPropertyPanelLst tr").each(function(e,t){var n,r=m(this),o=r.attr("data-fieldname");if(o){var i=r.find("input.field_value");if(0<i.length&&(n=m.trim(i.val()),o==T.enxConstField.AttrName.ENXFILE_ATTR_OBJNAME)){var a=E.GetObjectNameCache();a[n]&&a[n]!=u.EditNodeJson._id&&(n+=E.ConstInfo.RepeatedSingal,i.val(n))}var l=m(this).find("select");0<l.length&&(n=l.val()),void 0!==n&&(s[o]=n)}}),s},this.Show=function(){m("#"+u.ElementId).show(200)},this.Hide=function(){this.Reset(),m("#"+u.ElementId).hide(200)},this.Reset=function(){u.GetElement(".EplugGraphEditorPropertyPanelLst").empty()},this.AddField=function(e){var t=T.enxHelper.Format(u.HtmlTemplate.FieldEditItem,e,e,"");u.GetElement(".EplugGraphEditorPropertyPanelLst").append(t)},this.AddTr=function(e){u.GetElement(".EplugGraphEditorPropertyPanelLst").append(e)},this.EditNodeById=function(e){if(e&&(u.EditNodeJson=T.jsonHelper.GetJsonByKey(E.Property.DataList,T.enxHelper.Field.ID,e),!T.jsonHelper.IsEmptyJson(u.EditNodeJson))){u.Show(),u.Reset();var t=u.EditNodeJson.BigType,n=E.HtmlEditor.GetModelField(t),d=E.GetSpecialField(t),h=E.ConstInfo.SelectField;m.each(n,function(e,t){var n=E.GetDisplayFieldName(t),r=T.jsonHelper.GetJsonValue(u.EditNodeJson,t),o=T.jsonHelper.GetStrValue(r,T.enxConstField.AttrName.ENXFILE_ATTR_VALUE).replace(new RegExp('"',"gm"),"&quot;"),i=o,a="";if(E.ConstInfo.NoEditField.indexOf(t)<0){if(-1<d.indexOf(t)){var l=T.jsonHelper.GetJsonByKeyAndSecondKey(E.Property.LstPortJson,T.enxConstField.AttrName.ENXFILE_ATTR_GUID,T.enxConstField.AttrName.ENXFILE_ATTR_VALUE,o);T.jsonHelper.IsEmptyJson(l)||(i=l[T.enxConstField.AttrName.ENXFILE_ATTR_OBJNAME][T.enxConstField.AttrName.ENXFILE_ATTR_VALUE]),a=m(T.enxHelper.Format(u.HtmlTemplate.FieldShowItem,t,n,o,i)),u.BindEventForLink(a)}else if(-1<h.indexOf(t)){var s="",p=E.Property.SelectOptionValues[t];m.each(p,function(e,t){s+=i&&i==t?T.enxHelper.Format(u.HtmlTemplate.SelectOptionItem,t,t,"selected='selected'"):T.enxHelper.Format(u.HtmlTemplate.SelectOptionItem,t,t,"")}),a=m(T.enxHelper.Format(u.HtmlTemplate.FieldEditSelItem,t,n,s))}else a=m(T.enxHelper.Format(u.HtmlTemplate.FieldEditItem,t,n,o));u.AddTr(a)}});var r=T.jsonHelper.GetJsonAllKey(u.EditNodeJson),o=E.HtmlEditor.GetModelUnAvailField(t);o=o.concat(T.jsonHelper.GetJsonAllValue(T.enxHelper.Field),n);var i=m.grep(r,function(e){return-1==m.inArray(e,o)});u.CustomFields={},m.each(i,function(e,t){u.CustomFields[t]=u.EditNodeJson[t].value}),u.InitCustomFields()}},this.BindEventForLink=function(e){e.find(".EplugGraphEditorPropertyPanelFieldLink").off("click").click(function(){var e=m(this).attr("data-val");u.EditNodeById(e)})},this.InitCustomFields=function(){var e=u.CustomFields;m.isEmptyObject(e)?u.AddCustomField():m.each(e,function(e,t){u.AddCustomField(void 0,e,t)})},this.AddCustomField=function(e,t,n){var r=m(T.enxHelper.Format(u.HtmlTemplate.FieldEditCustomItem,t||"",n||""));e?e.after(r):u.AddTr(r),u.BindEventForCustomOps(r)},this.BindEventForCustomOps=function(t){t.off("click").on("click",".custom_field_add,.custom_field_delete",function(){m(this).hasClass("custom_field_add")?u.AddCustomField(t):(t.remove(),u.updateProperties())}),t.off("change").on("change",".custom_field_key",function(){var e=m.trim(m(this).val());e&&t.attr("data-fieldname",e)})}},this.GetDisplayNodeName=function(e,t){if(!T.jsonHelper.IsEmptyJson(e)){var n=e[T.enxConstField.AttrName.ENXFILE_ATTR_OBJNAME][T.enxConstField.AttrName.ENXFILE_ATTR_VALUE],r=T.jsonHelper.GetJsonValue(e,T.enxConstField.AttrName.ENXFILE_ATTR_ROLER)[T.enxConstField.AttrName.ENXFILE_ATTR_VALUE],o=n;if(e.BigType==T.enxHelper.ModelType.Ne&&r&&(o+="("+r+")"),t&&e.BigType==T.enxHelper.ModelType.Port){var i=T.jsonHelper.GetJsonValue(e,T.enxConstField.AttrName.ENXFILE_ATTR_INTERFACE)[T.enxConstField.AttrName.ENXFILE_ATTR_VALUE];i&&(o=i)}return o}},this.RenderData=function(){this.Property.CoreGraph.getModel().beginUpdate();var p=this.Property.CoreGraph.getDefaultParent();p[this.ConstInfo.AttrName.CANVASID]=E.Property.TopoNode._id,p[this.ConstInfo.AttrName.BIGTYPE]=E.Property.TopoNode.BigType;try{var d={};m.each(E.Property.LstNodeJson,function(e,t){var n=c.Translater.JsonToCell(c.Property.CoreGraph,t,p),r=t[T.enxConstField.AttrName.ENXFILE_ATTR_OBJNAME][T.enxConstField.AttrName.ENXFILE_ATTR_VALUE];d[r]=n}),m.each(E.Property.LstLinkJson,function(e,t){var n=T.jsonHelper.GetJsonValue(t,T.enxConstField.AttrName.ENXFILE_ATTR_SOURCETOPDEVICENAME)[T.enxConstField.AttrName.ENXFILE_ATTR_VALUE],r=T.jsonHelper.GetJsonValue(t,T.enxConstField.AttrName.ENXFILE_ATTR_TARGETTOPDEVICENAME)[T.enxConstField.AttrName.ENXFILE_ATTR_VALUE],o=T.jsonHelper.GetJsonValue(d,n),i=T.jsonHelper.GetJsonValue(d,r);if(T.jsonHelper.IsEmptyJson(o)&&T.jsonHelper.IsEmptyJson(i))return!0;var a=t[T.enxConstField.AttrName.ENXFILE_ATTR_OBJNAME][T.enxConstField.AttrName.ENXFILE_ATTR_VALUE],l=t[T.enxHelper.Field.ID];if(c.InsertLink(p,l,a,o,i,T.enxHelper.ModelType.Link,t),t.group){var s=t.group.value;c.ResetMaxGroupIndex(s)}})}finally{this.Property.CoreGraph.getModel().endUpdate()}},this.RenderVirtualLink=function(i,a,l){var e=this.GetLinksBetween(i,a,!1),s=this.Property.CoreGraph,p=this;if(s.removeCells(e),l){var d=s.getDefaultParent();s.getModel().beginUpdate();try{m.each(l,function(e,t){var n=t.source.rootdevice._id==i.id?i:a,r=t.target.rootdevice._id==a.id?a:i,o=c.InsertLink(d,t.id,t.objname,n,r,T.enxHelper.ModelType.Link,t.data);e==l.length-1&&(s.setSelectionCell(o),p.SubGraph.SetTopNav(o.data))})}finally{s.getModel().endUpdate()}}},this.GetLinksBetween=function(e,t,n){var r=[];if(r=this.Property.CoreGraph.getModel().getEdgesBetween(e,t,!1),n){var o=this.Property.CoreGraph.getModel().getEdgesBetween(e,e,!1);r=r.concat(o);var i=this.Property.CoreGraph.getModel().getEdgesBetween(t,t,!1);r=r.concat(i)}return r},this.RemoveLink=function(n,r){this.Property.CoreGraph.removeCells([n]);var e=this.Property.CoreGraph.getModel().getEdgesBetween(n.source,n.target,!1),o=n.data&&n.data.group&&n.data.group.groupshow,i=[];m.each(e,function(e,t){o&&t.data.group&&t.data.group.value==n.data.group.value&&(r?(c.RemoveLink(t),E.RemoveModel(T.enxHelper.Field.ID,t.id)):i.push(t.id))}),0<i.length&&c.GroupLink(i)},this.AttachCell=function(e,t){var n=t[T.enxHelper.Field.ID],r=t[T.enxHelper.Field.BigType],o=t[T.enxConstField.AttrName.ENXFILE_ATTR_OBJNAME][T.enxConstField.AttrName.ENXFILE_ATTR_VALUE];e[c.ConstInfo.AttrName.BIGTYPE]=r,e[c.ConstInfo.AttrName.OBJNAME]=o,e[c.ConstInfo.AttrName.DATA]=t,e[c.ConstInfo.AttrName.CANVASID]=n,e[c.ConstInfo.AttrName.ID]=n},this.ResetMaxGroupIndex=function(e){var t=e.match(new RegExp("0|[1-9]\\d*","gm"));t&&0<t.length&&this.Property.LinkGroupIndex<=parseInt(t[t.length-1])&&(this.Property.LinkGroupIndex=parseInt(t[t.length-1])+1)},this.Translater=new function(){this.FixFlex=new function(){this.XAdd=5,this.YAdd=25},this.GetJsonBond=function(e){var t=[0,0,c.ConstInfo.FixWidth,c.ConstInfo.FixHeight],n=T.jsonHelper.GetJsonValue(e,T.enxConstField.AttrName.ENXFILE_ATTR_POSITION)[T.enxConstField.AttrName.ENXFILE_ATTR_VALUE];if(n&&-1<n.indexOf(";")){var r=n.split(";"),o=0,i=0;if(-1<r[0].indexOf(",")){var a=r[0].split(",");o=parseInt(a[0])-this.FixFlex.XAdd,i=parseInt(a[1])-this.FixFlex.YAdd}if(-1<r[1].indexOf(",")){var l=r[1].split(",");parseInt(l[0]),this.FixFlex.XAdd,parseInt(l[1]),this.FixFlex.YAdd}t[0]=o,t[1]=i,t[2]=62,t[3]=62}return t},this.BondToString=function(e){var t=e[c.ConstInfo.AttrName.GEOMETRY];t||(t={x:0,y:0,width:0,height:0});var n=t.x+this.FixFlex.XAdd,r=t.y+this.FixFlex.YAdd;return n+","+r+";"+(n+t.width)+","+(r+t.height)},this.JsonToCell=function(e,t,n,r,o,i){if(!m.isEmptyObject(t)){var a=r;r&&0!=r.length||(a=c.Translater.GetJsonBond(t));var l=t[T.enxHelper.Field.ID],s=c.GetDisplayNodeName(t,i),p=t[T.enxHelper.Field.BigType],d=(t[T.enxConstField.AttrName.ENXFILE_ATTR_OBJNAME][T.enxConstField.AttrName.ENXFILE_ATTR_VALUE],e.insertVertex(n,l,s,a[0],a[1],a[2],a[3],o||p));return c.AttachCell(d,t),d}}},this.GetImagePath=function(e){var t=E.OptionParam;return t.root+t.imageDir+e},this.ConfigureStylesheet=function(){var e={};e[mxConstants.STYLE_SHAPE]=mxConstants.SHAPE_IMAGE,e[mxConstants.STYLE_IMAGE]=this.GetImagePath("v-ne.png"),e[mxConstants.STYLE_VERTICAL_ALIGN]=mxConstants.ALIGN_TOP,e[mxConstants.STYLE_VERTICAL_LABEL_POSITION]=mxConstants.ALIGN_BOTTOM,e[mxConstants.STYLE_FONTCOLOR]="#333",this.Property.CoreGraph.getStylesheet().putCellStyle(T.enxHelper.ModelType.Ne,e);var t=m.extend({},e);t[mxConstants.STYLE_IMAGE]=this.GetImagePath("v-tester.png"),this.Property.CoreGraph.getStylesheet().putCellStyle(T.enxHelper.ModelType.Tester,t);var n=m.extend({},e);n[mxConstants.STYLE_IMAGE]=this.GetImagePath("v-tester.png"),this.Property.CoreGraph.getStylesheet().putCellStyle(T.enxHelper.ModelType.Dev,n);var r=m.extend({},e);r[mxConstants.STYLE_IMAGE]=this.GetImagePath("v-atm.png"),this.Property.CoreGraph.getStylesheet().putCellStyle(T.enxHelper.ModelType.Atm,r);var o=m.extend({},e);o[mxConstants.STYLE_IMAGE]=this.GetImagePath("v-eth.png"),this.Property.CoreGraph.getStylesheet().putCellStyle(T.enxHelper.ModelType.Eth,o);var i=m.extend({},e);i[mxConstants.STYLE_IMAGE]=this.GetImagePath("v-sdh.png"),this.Property.CoreGraph.getStylesheet().putCellStyle(T.enxHelper.ModelType.Sdh,i);var a=m.extend({},e);a[mxConstants.STYLE_IMAGE]=this.GetImagePath("v-sftp.png"),this.Property.CoreGraph.getStylesheet().putCellStyle(T.enxHelper.ModelType.Sftp,a);var l=m.extend({},e);l[mxConstants.STYLE_IMAGE]=this.GetImagePath("v-agent.png"),this.Property.CoreGraph.getStylesheet().putCellStyle(T.enxHelper.ModelType.Agent,l);var s=m.extend({},e);s[mxConstants.STYLE_IMAGE]=this.GetImagePath("v-network.png"),this.Property.CoreGraph.getStylesheet().putCellStyle(T.enxHelper.ModelType.Network,s);var p={};p[mxConstants.STYLE_STROKECOLOR]=c.ConstInfo.LineDefualtColor,p[mxConstants.STYLE_STROKEWIDTH]=1.3,p[mxConstants.STYLE_FONTSTYLE]=2,p[mxConstants.STYLE_PERIMETER_SPACING]=1,p[mxConstants.STYLE_ENDARROW]="",p[mxConstants.STYLE_FONTCOLOR]="#5e698a",p[mxConstants.STYLE_FONTSIZE]=12,p[mxConstants.STYLE_VERTICAL_ALIGN]=mxConstants.ALIGN_BOTTOM,this.Property.CoreGraph.getStylesheet().putCellStyle(T.enxHelper.ModelType.Link,p);var d=m.extend({},p);d[mxConstants.STYLE_CURVED]=!0,this.Property.CoreGraph.getStylesheet().putCellStyle(c.ConstInfo.LoopLinkStyleName,d);var h=m.extend({},p);h[mxConstants.STYLE_CURVED]=!0,h[mxConstants.STYLE_STROKEWIDTH]=1.3,h[mxConstants.STYLE_STROKECOLOR]="#525ae9",this.Property.CoreGraph.getStylesheet().putCellStyle(c.ConstInfo.LoopGroupLinkStyleName,h);var u=m.extend({},p);u[mxConstants.STYLE_DASHED]=1,this.Property.CoreGraph.getStylesheet().putCellStyle(c.ConstInfo.VirtualLinkStyleName,u)},this.GetAllNode=function(r,e,o){var t=e||r.getDefaultParent(),i=r.getModel().getChildVertices(t);return o&&i&&0<i.length&&m.each(i,function(e,t){var n=c.GetAllNode(r,t,o);i=i.concat(n)}),i},this.GetAllLink=function(r,e,o){var i=[],t=e||r.getDefaultParent();if(i=r.getModel().getChildEdges(t),o){var n=r.getModel().getChildVertices(t);m.each(n,function(e,t){var n=c.GetAllLink(r,t,o);i=i.concat(n)})}return i},this.GetCellsByFieldValue=function(e,t,n){var r=[];switch(e){case T.enxHelper.ModelType.Ne:case T.enxHelper.ModelType.Tester:case T.enxHelper.ModelType.Dev:case T.enxHelper.ModelType.Sdh:case T.enxHelper.ModelType.Atm:case T.enxHelper.ModelType.Eth:case T.enxHelper.ModelType.Board:case T.enxHelper.ModelType.SubBoard:case T.enxHelper.ModelType.Port:r=this.GetAllNode(c.Property.CoreGraph);break;case T.enxHelper.ModelType.Link:r=this.GetAllLink(c.Property.CoreGraph);break;default:r=this.GetAllNode(c.Property.CoreGraph)}return T.jsonHelper.GetJsonByKey(r,t,n)},this.UpdateCell=function(e,t){var n,r=T.jsonHelper.GetStrValue(t,T.enxHelper.Field.ID),o=t.IsTopDevice==T.enxConstField.BoolStr.Yes,i=e==T.enxHelper.ModelType.Link;if(o||i)n=c.GetCellsByFieldValue(e,c.ConstInfo.AttrName.ID,r);else{var a=c.GetAllNode(c.SubGraph.Graph,null,!0);n=T.jsonHelper.GetJsonByKey(a,c.ConstInfo.AttrName.ID,t._id)}if(!T.jsonHelper.IsEmptyJson(n)){var l=n.objname!=t.objname.value;o&&l&&c.UpdateCellRelChildren(r,n.objname,t.objname.value);var s=c.GetDisplayNodeName(t);n[c.ConstInfo.AttrName.OBJNAME]=t[T.enxConstField.AttrName.ENXFILE_ATTR_OBJNAME][T.enxConstField.AttrName.ENXFILE_ATTR_VALUE],n[c.ConstInfo.AttrName.DATA]=t,c.Property.CoreGraph.getModel().setValue(n,s),c.SubGraph.Graph.getModel().setValue(n,s),(o&&l||i)&&c.SubGraph.EditCell(n)}},this.UpdateCellRelChildren=function(e,r,o){var t=E.GetChildrens(e,!0);m.each(t,function(e,t){var n=t.objname.value;0==n.indexOf(r)&&n.substr(r.length,1)==T.enxConstField.NameSeparate&&(n=n.replace(r,o)),t[T.enxConstField.AttrName.ENXFILE_ATTR_OBJNAME][T.enxConstField.AttrName.ENXFILE_ATTR_VALUE]=n,c.UpdateCell(t.BigType,t)})},this.BasicFixSet=function(){this.Property.CoreGraph.cellsResizable=!1,this.Property.CoreGraph.cellsEditable=!1,this.Property.CoreGraph.edgeLabelsMovable=!1,this.Property.CoreGraph.allowDanglingEdges=!1,this.Property.CoreGraph.allowLoops=!0,this.Property.CoreGraph.setConnectable(!0),this.Property.CoreGraph.setDropEnabled(!0),this.Property.CoreGraph.setTooltips(!0);var t=new mxParallelEdgeLayout(this.Property.CoreGraph);new mxLayoutManager(this.Property.CoreGraph).getLayout=function(e){if(0<e.getChildCount())return t},new mxRubberband(this.Property.CoreGraph),c.ConfigureStylesheet(),mxConstants.DEFAULT_FONTFAMILY="Helvetica,Arial",mxConstants.VERTEX_SELECTION_COLOR="#87CEEB",mxConstants.VERTEX_SELECTION_STROKEWIDTH=1.3,mxConstants.VERTEX_SELECTION_DASHED=!1,mxConstants.EDGE_SELECTION_COLOR="#87CEEB",mxConstants.EDGE_SELECTION_DASHED=!1,mxConstants.EDGE_SELECTION_STROKEWIDTH=1.3,mxConstants.DEFAULT_FONTSIZE=14,mxConstants.HIGHLIGHT_STROKEWIDTH=1.3,mxConstants.LOCKED_HANDLE_FILLCOLOR="#87CEEB",mxConstants.HANDLE_STROKECOLOR="#87CEEB",mxEvent.disableContextMenu(this.Property.Contain),new mxCellTracker(this.Property.CoreGraph,"#87CEEB"),mxCellHighlight.prototype.spacing=0,this.Property.CoreGraph.setCellsResizable(!1),this.Property.CoreGraph.setCellsBendable(!1),delete this.Property.CoreGraph.getStylesheet().getDefaultEdgeStyle().endArrow,mxRectangleShape.prototype.crisp=!0,mxGraphHandler.prototype.guidesEnabled=!0,this.PermissionApply(new this.Permission(!1),this.Property.CoreGraph),this.ExtendsHook(this.Property.CoreGraph),this.Property.CoreGraph.getTooltipForCell=function(e){if(e.vertex){var t=e.data;return'<ul class="core_tip"><li><span class="tip_title">Name:</span><span>'+t.objname.value+'</span></li><li><span class="tip_title">IP:</span><span>'+t.ip.value+'</span></li><li><span class="tip_title">Type:</span><span>'+t.type.value+"</span></li></ul>"}return e.value},this.IconSet(this.Property.CoreGraph)},this.IconSet=function(r){function n(t){this.images=[],t.view.graph;var e=mxUtils.createImage(c.GetImagePath("edit.png"));e.setAttribute("title","Edit"),e.style.position="absolute",e.style.cursor="pointer",e.style.width="20px",e.style.height="20px",e.style.left=t.x+t.width+"px",e.style.top=t.y-16+"px",mxEvent.addGestureListeners(e,mxUtils.bind(this,function(e){mxEvent.consume(e)})),mxEvent.addListener(e,"click",mxUtils.bind(this,function(e){c.PropertyPanel.EditNodeById(t.cell.id),mxEvent.consume(e),this.destroy()})),t.view.graph.container.appendChild(e),this.images.push(e)}n.prototype.destroy=function(){if(null!=this.images)for(var e=0;e<this.images.length;e++){var t=this.images[e];t.parentNode.removeChild(t)}this.images=null},r.addMouseListener({currentState:null,currentIconSet:null,mouseDown:function(e,t){null!=this.currentState&&(this.dragLeave(t.getEvent(),this.currentState),this.currentState=null)},mouseMove:function(e,t){if(null!=this.currentState&&(t.getState()==this.currentState||null==t.getState())){var n=new mxRectangle(t.getGraphX()-20,t.getGraphY()-20,40,40);if(mxUtils.intersects(n,this.currentState))return}n=r.view.getState(t.getCell()),(r.isMouseDown||null!=n&&!r.getModel().isVertex(n.cell))&&(n=null),n!=this.currentState&&(null!=this.currentState&&this.dragLeave(t.getEvent(),this.currentState),this.currentState=n,null!=this.currentState&&this.dragEnter(t.getEvent(),this.currentState))},mouseUp:function(e,t){},dragEnter:function(e,t){null==this.currentIconSet&&(this.currentIconSet=new n(t))},dragLeave:function(e,t){null!=this.currentIconSet&&(this.currentIconSet.destroy(),this.currentIconSet=null)}})},this.ExtendsHook=function(e){var r=e.isCellDisconnectable;e.isCellDisconnectable=function(e,t,n){return r.apply(this,arguments)&&o.editEdges}},this.PermissionApply=function(e,t){o=e},this.Permission=function(e,t,n,r,o){this.editEdges=null==e||e,this.editVertices=null==t||t,this.locked=null!=n&&n,this.createEdges=null==r||r,this.cloneCells=null==o||o},this.Permission.prototype.apply=function(e){e.setConnectable(this.createEdges),e.setCellsLocked(this.locked)},this.GetCurrentGraph=function(){return c.EditType==c.ConstInfo.EnumEditType.Topo&&(graph=c.Property.CoreGraph),c.EditType==c.ConstInfo.EnumEditType.Element&&(graph=c.SubGraph.Graph),graph},this.ConnectHandler=mxUtils.bind(this,function(e,t){var n=t.properties.edge,r=c.Property.CoreGraph;return r.getModel(),!!n.target&&(n.source.bigtype==T.enxHelper.ModelType.Network&&n.target.bigtype==T.enxHelper.ModelType.Network?(r.removeCells([n]),toastr.warning("No connection between the network!"),!1):(n.bigtype=T.enxHelper.ModelType.Link,n.style=c.ConstInfo.VirtualLinkStyleName,void setTimeout(function(){r.fireEvent(new mxEventObject(mxEvent.CLICK,"event",t,"cell",n))},100)))}),this.BindEventForMenu=function(){m(".spanEditorBtnSaveImg").off("click").click(function(){c.SaveAsImage()})},this.GetImageUrl=function(){var t="",e=c.GetCurrentGraph(),n=e.getGraphBounds(),r=Math.round(n.x+n.width+4),o=Math.round(n.y+n.height+4),i=mxUtils.getXml(mxUtils.getViewXml(e,1),"\n"),a={height:o,width:r,mxXml:encodeURIComponent(i)};return m.ajax({type:"POST",url:"/Home/EnxToImage",data:JSON.stringify(a),dataType:"json",contentType:"application/json; charset=utf-8",success:function(e){t=e.url,window.open("about:blank").document.write("<img src='"+t+"' alt='No Image'/>")}}),t},this.SaveAsImage=function(){c.GetImageUrl()},this.OnClick=function(e,t){c.EditType=c.ConstInfo.EnumEditType.Topo,c.SelectItemHandle();var n=t.getProperty("cell");E.toggleRightContainer(n),c.PropertyPanel.Hide(),c.SubGraph.EditCell(n)},this.BindEvent=function(){c.Property.CoreGraph.addListener(mxEvent.CLICK,c.OnClick);var e=m(".EplugGraphEditorElementItem,.SubToolbarItem");m.each(e,function(e,t){mxClient.IS_IE&&mxEvent.addListener(t,"dragstart",function(e){e.returnValue=!1}),t.onselectstart=function(){return!1};var n=mxUtils.makeDraggable(t,function(e){return c.EditType=m(t).attr("data-edittype"),c.GetCurrentGraph()},function(e,t,n,r,o){c.DropInElement(e,t,n,r,o,this.dragElement)},t.cloneNode(!0),null,null,c.Property.CoreGraph.autoscroll,!0);n.isGuidesEnabled=function(){return c.Property.CoreGraph.graphHandler.guidesEnabled},n.createDragElement=mxDragSource.prototype.createDragElement}),c.Property.CoreGraph.removeListener(c.ConnectHandler),c.Property.CoreGraph.addListener(mxEvent.CELL_CONNECTED,c.ConnectHandler),c.BindKeyEvent()},this.KeyHandler=function(e){if(!c.Property.CoreGraph.isSelectionEmpty()){var t=0,n=0;37==e?t=-1:38==e?n=-1:39==e?t=1:40==e&&(n=1),c.Property.CoreGraph.moveCells(c.Property.CoreGraph.getSelectionCells(),t,n)}},this.BindKeyEvent=function(){var e=new mxKeyHandler(c.Property.CoreGraph);e.bindKey(13,function(){var e=c.GetCurrentGraph().getSelectionCell();e&&c.PropertyPanel.EditNodeById(e.id)}),e.bindKey(37,function(){c.KeyHandler(37)}),e.bindKey(38,function(){c.KeyHandler(38)}),e.bindKey(39,function(){c.KeyHandler(39)}),e.bindKey(40,function(){c.KeyHandler(40)}),e.bindKey(46,function(){var e=c.GetCurrentGraph().getSelectionCells();c.EditType==c.ConstInfo.EnumEditType.Topo&&c.RemoveSelectCell(e),c.EditType==c.ConstInfo.EnumEditType.Element&&c.SubGraph.RemoveSelectCell(e)}),e.bindControlKey(65,function(){c.selectAll()}),e.bindControlKey(67,function(){c.Copy()}),e.bindControlKey(86,function(){c.Paste()})},this.GetTopDeviceBond=function(e,t,n){return[t,n,62,62]},this.DropInElement=function(e,t,n,r,o,i){var a,l=m(i).attr("data-type"),s={},p=[],d="";if(c.EditType==c.ConstInfo.EnumEditType.Topo&&(e=c.Property.CoreGraph,-1<T.enxHelper.ModelTypeOfTopDevice.indexOf(l)&&(s=e.getDefaultParent(),p=c.GetTopDeviceBond(l,r,o))),c.EditType==c.ConstInfo.EnumEditType.Element){var h=n&&n.bigtype||"";h!=T.enxHelper.ModelType.Ne||l!=T.enxHelper.ModelType.Board&&l!=T.enxHelper.ModelType.Port&&l!=T.enxHelper.ModelType.VM&&l!=T.enxHelper.ModelType.Network?(h==T.enxHelper.ModelType.Board||h==T.enxHelper.ModelType.VM)&&(l==T.enxHelper.ModelType.SubBoard||l==T.enxHelper.ModelType.Port)||h==T.enxHelper.ModelType.SubBoard&&l==T.enxHelper.ModelType.Port?s=n:h!=T.enxHelper.ModelType.Tester&&h!=T.enxHelper.ModelType.Sftp&&h!=T.enxHelper.ModelType.Agent||l!=T.enxHelper.ModelType.Port||(s=n):s=n,c.SubGraph.ResetNodeMovable(),e=c.SubGraph.Graph,d=c.ConstInfo.SwimStyle}if(T.jsonHelper.IsEmptyJson(s))toastr.warning("Subelements are not allowed to add!");else if((a=c.ExcuteDropInElement(e,s,l,p,d)).vertex){var u=m(e.container);u.scrollTop(u.height()),e.setSelectionCell(a),e.fireEvent(new mxEventObject(mxEvent.CLICK,"event",t,"cell",a))}},this.ExcuteDropInElement=function(e,t,n,r,o){var i=T.jsonHelper.GetStrValue(t,c.ConstInfo.AttrName.OBJNAME),a=T.jsonHelper.GetStrValue(t,c.ConstInfo.AttrName.CANVASID),l=T.jsonHelper.GetStrValue(t,c.ConstInfo.AttrName.BIGTYPE),s=E.CreateModel(n,a,i,l),p=r;r&&0!=r.length||(p=c.SubGraph.GetBond(n));var d=this.Translater.JsonToCell(e,s,t,p,o);return c.EditType==c.ConstInfo.EnumEditType.Topo?d.setConnectable(!0):(c.SubGraph.EditGraphCell.vertex?d.setConnectable(!1):d.setConnectable(d.bigtype==T.enxHelper.ModelType.Port||d.bigtype==T.enxHelper.ModelType.Network),c.SubGraph.SetNodeCannotMove(),e.cellRenderer.redrawLabel(e.view.getState(d))),d},this.InitPopMenu=function(){c.Property.CoreGraph.popupMenuHandler.factoryMethod=function(e,n,t){var r=c.Property.CoreGraph.getSelectionCells(),o=function(e,t){m(e).find("td:last").html('<span class="mxMenu-key">'+t+"</span>")};if(n&&n.edge){var i=n.source.id,a=n.target.id,l=m.grep(r,function(e,t){return e.edge&&e.id!=n.id&&(e.source.id==i&&e.target.id==a||e.target.id==i&&e.source.id==a)});0<l.length&&e.addItem("Group",null,function(){c.CombineLinkToGroup(n,l,!0)},null),n.group&&e.addItem("UnGroup",null,function(){c.PullLinkFromGroup(n)},null)}n&&n.vertex&&o(e.addItem("Copy",null,function(){c.Copy()},null,"mxMenu copy"),"Ctrl+C"),0<r.length?(1==r.length&&o(e.addItem("Edit",null,function(){c.PropertyPanel.EditNodeById(r[0].id)},null,"mxMenu edit"),"Enter"),o(e.addItem("Delete",null,function(){c.RemoveSelectCell(r)},null,"mxMenu delete"),"Del")):o(e.addItem("Select All",null,function(){c.selectAll()},null,"mxMenu select"),"Ctrl+A"),n||mxClipboard.isEmpty()||o(e.addItem("Paste",null,function(){c.Paste()},null,"mxMenu paste"),"Ctrl+V")}},this.RemoveSelectCell=function(e){var o=[],i=[];m.each(e,function(e,t){if(t.bigtype==T.enxHelper.ModelType.Link){if(o.push(t),t.group){var n=c.GetSameGroupLink(t);o=o.concat(n)}}else{i.push(t);var r=t.edges;r&&m.each(r,function(e,t){E.RemoveModel(T.enxHelper.Field.ID,t.id)}),E.RemoveModelByParentId(t.id,!0)}E.RemoveModel(T.enxHelper.Field.ID,t.id)}),m.each(o,function(e,t){c.RemoveLink(t,!0)}),c.Property.CoreGraph.removeCells(i,!0),c.SubGraph.EditCell()},this.RemoveCellById=function(e,t){var n=c.Property.CoreGraph,r=[];switch(e){case T.enxHelper.ModelType.Link:r=this.GetAllLink(n);break;case T.enxHelper.ModelType.Ne:case T.enxHelper.ModelType.Tester:case T.enxHelper.ModelType.Sftp:case T.enxHelper.ModelType.Agent:case T.enxHelper.ModelType.Network:case T.enxHelper.ModelType.Atm:case T.enxHelper.ModelType.Eth:case T.enxHelper.ModelType.Sdh:r=this.GetAllNode(n)}if(r&&0!=r.length){var o=T.jsonHelper.GetJsonByKey(r,"id",t);o.id&&(e==T.enxHelper.ModelType.Link?c.RemoveLink(o):n.removeCells([o]))}},this.GetSameGroupLink=function(n){var e=c.GetAllLink(c.Property.CoreGraph);return m.grep(e,function(e,t){return e.edge&&e.group&&e.group==n.group&&e.id!=n.id})},this.SetNodeAttr=function(e,t,n){var r=e.bigtype;E.SetNodeAttr(r,e.id,t,n),e[t]=n[T.enxConstField.AttrName.ENXFILE_ATTR_VALUE]},this.RemoveNodeAttr=function(e,t){var n=e.bigtype;E.DeleteNodeAttr(n,e.id,t),delete e[t]},this.CombineLinkToGroup=function(e,t,r){if(t&&0<t.length){c.Property.CoreGraph.toggleCells(!1,t);var n=c.CreateLinkGroupName(e),o=T.enxHelper.AttrParameter(c.ConstInfo.AttrName.GROUP,n);c.PushLinkToGroup(e,n),m.each(t,function(e,t){if(r){var n=c.GetSameGroupLink(t);n&&0<n.length&&(c.PullLinkFromGroupStyle(t),m.each(n,function(e,t){c.SetNodeAttr(t,c.ConstInfo.AttrName.GROUP,o)}))}c.SetNodeAttr(t,c.ConstInfo.AttrName.GROUP,o)})}},this.PushLinkToGroup=function(e,t){var n=T.enxHelper.AttrParameter(c.ConstInfo.AttrName.GROUP,t);n[T.enxConstField.AttrName.ENXFILE_ATTR_GROUPSHOW]="true",c.SetNodeAttr(e,c.ConstInfo.AttrName.GROUP,n),c.Property.CoreGraph.getModel().setValue(e,t),c.Property.CoreGraph.setCellStyle(c.ConstInfo.LinkGroupedStyle,[e]),this.CopyLink(e,!0)},this.CopyLink=function(e,t){t&&c.Property.CoreGraph.removeCells([e]),this.InsertLink(e.parent,e.id,e.value,e.source,e.target,e.style,e.data)},this.InsertLink=function(e,t,n,r,o,i,a){c.Property.CoreGraph.removeListener(c.ConnectHandler),this.Property.CoreGraph.getModel().beginUpdate();try{var l=c.Property.CoreGraph.insertEdge(e,t,n,r,o,i);this.AttachCell(l,a),a.group?(l.group=a.group.value?a.group.value:"",a.group.groupshow?(c.Property.CoreGraph.getModel().setValue(l,a.group.value),i=c.ConstInfo.LinkGroupedStyle,l.source.id==l.target.id&&(i=c.ConstInfo.LoopGroupLinkStyleName),c.Property.CoreGraph.setCellStyle(i,[l])):c.Property.CoreGraph.toggleCells(!1,[l])):r.id==o.id&&this.Property.CoreGraph.getModel().setStyle(l,c.ConstInfo.LoopLinkStyleName)}finally{this.Property.CoreGraph.getModel().endUpdate()}return c.Property.CoreGraph.addListener(mxEvent.CELL_CONNECTED,c.ConnectHandler),l},this.Copy=function(){var e=c.Property.CoreGraph.getSelectionCells(),t=T.jsonHelper.FilterListByValues(e,c.ConstInfo.AttrName.VERTEX,[!0]);mxClipboard.copy(c.Property.CoreGraph,t)},this.Paste=function(){var o=c.Property.CoreGraph,e=o.getImportableCells(mxClipboard.getCells());m.each(e,function(e,r){var t=E.CopyModel(r.data);t&&0<t.length&&m.each(t,function(e,t){if(0==e){var n=c.Translater.GetJsonBond(t);n[0]=o.popupMenuHandler.triggerX||n[0]+10,n[1]=o.popupMenuHandler.triggerY||n[1]+10,c.Translater.JsonToCell(o,t,o.getDefaultParent(),n,r.style)}})})},this.selectAll=function(){c.Property.CoreGraph.selectAll()},this.PullLinkFromGroup=function(e){var t=c.GetSameGroupLink(e);m.each(t,function(e,t){c.RemoveNodeAttr(t,c.ConstInfo.AttrName.GROUP)}),c.Property.CoreGraph.toggleCells(!0,t),this.PullLinkFromGroupStyle(e),this.RemoveNodeAttr(e,c.ConstInfo.AttrName.GROUP)},this.PullLinkFromGroupStyle=function(e){var t=c.GetDisplayNodeName(e.data);c.Property.CoreGraph.getModel().setValue(e,t),e.source.id==e.target.id?this.Property.CoreGraph.getModel().setStyle(e,c.ConstInfo.LoopLinkStyleName):c.Property.CoreGraph.setCellStyle(c.ConstInfo.LinkUnGroupStyle,[e])},this.SelectItemHandle=function(){c.Property.CoreGraph.getDefaultParent();var e=c.Property.CoreGraph.getSelectionCells();c.Property.SelectedVertexId=[],c.Property.SelectedLinkId=[],m.each(e,function(e,t){if(t.vertex&&c.Property.SelectedVertexId.push(t[c.ConstInfo.AttrName.ID]),t.edge){c.Property.SelectedLinkId.push(t[c.ConstInfo.AttrName.ID]);var n=c.GetSameGroupLink(t);m.each(n,function(e,t){c.Property.SelectedLinkId.push(t[c.ConstInfo.AttrName.ID])})}})},this.ClearChildren=function(){this.Property.LinkGroupIndex=0,c.Property.CoreGraph&&c.Property.CoreGraph.getModel()&&c.Property.CoreGraph.getModel().root&&c.Property.CoreGraph.getModel().clear()},this.CreateLinkGroupName=function(e){var t="";return e.group?t=e.group:(t=this.ConstInfo.LinkGroupPre+this.Property.LinkGroupIndex,this.Property.LinkGroupIndex++),t},this.ConstInfo=new function(){this.FixWidth=62,this.FixHeight=62,this.AttrName={PARENT:"parent",VALUE:"value",CONNECTABLE:"connectable",ID:"id",SOURCE:"source",STYLE:"style",TARGET:"target",VERTEX:"vertex",GEOMETRY:"geometry",EDGE:"edge",GROUP:"group",OBJNAME:"objname",BIGTYPE:"bigtype",DATA:"data",CANVASID:"canvasID",ISVIRTUALEDGE:"isVirtualEdge"},this.LinkGroupPre="Group",this.ElemntNamePre=new function(){this.Link="link",this.Ne="ne",this.Tester="tester",this.Dev="dev",this.Atm="atm",this.Eth="eth",this.Sdh="sdh",this.Board="board",this.SubBoard="subboard",this.Port="port",this.Network="network",this.Sftp="sftp",this.Agent="agent",this.VM="vm"},this.LinkGroupedStyle="strokeColor=#525ae9;strokeWidth=4;",this.LinkUnGroupStyle="strokeColor=#009b4d;strokeWidth=2;",this.SwimStyle="shape=swimlane;startSize=30;fillColor=#f6f6f6;strokeColor=#f6f6f6;fontColor=#333;",this.UsedPort="shape=swimlane;startSize=30;fillColor=#f6f6f6;strokeColor=#f6f6f6;fontColor=#999;",this.LineDefualtColor="#a5a5a5",this.LoopGroupLinkStyleName="LoopGroupLinkStyleName",this.LoopLinkStyleName="LoopLinkInCoreGraph",this.LoopGroupLinkInCoreGraph="LoopGroupLinkInCoreGraph",this.VirtualLinkStyleName="VirtualLinkStyleName",this.SubGraphHtml='<div id="graphContainer"></div>',this.EnumEditType={Topo:"Topo",Element:"Element",Network:"Network"}},this.EditType=this.ConstInfo.EnumEditType.Topo,this.Init()};return function(e){this.PlugObj={},this.Init=function(e){var t=new n;return t.Init(e),this.BindEvent(t),this.PlugObj=t},this.BindEvent=function(i){m(".spanEditorViewText").off("click").click(function(){i.ViewText()}),m(".spanEditorTopolimit").off("click").click(function(){m(".EPlugTopolimitSubmit").off("click").click(function(){var n=m("#txtTopoLimit").val(),e={BigType:T.enxHelper.ModelType.Topolimit,Name:n},r=!1;m.each(i.Property.DataList,function(e,t){t.BigType==T.enxHelper.ModelType.Topolimit&&(t.Name=n,r=!0)}),r||i.Property.DataList.push(e),m("#modalTopolimit").modal("hide")}),m(".EPlugTopolimitClose").off("click").click(function(){m("#modalTopolimit").modal("hide")}),m("#txtTopoLimit").val(""),m("#modalTopolimit").modal()}),m(".spanEditorBtnOpenEnx").off("click").click(function(){var o=m("#modalOpenEnx");m(".EPlugImportSubmit").off("click").click(function(){var e=m(".EPlugEnxInput").val(),t=m("#EPlugImportBtn").val();i.Property.FileName=t.substr(t.lastIndexOf("\\")+1);var n=T.enxHelper.EnxToLstJson(e);i.SetData(n);var r="";m.each(n,function(e,t){r+=JSON.stringify(t)+"\n\r"}),m(".EPlugEnxInput").val(r),o.modal("hide")}),m(".EPlugImportClose").off("click").click(function(){o.modal("hide")}),m("#EPlugImportBtn").val(""),m(".EPlugEnxInput").val(""),o.modal()}),m(".spanEditorBtnSaveEnx").off("click").click(function(){i.SaveData(!0)}),m("#EPlugImportBtn").off("change").change(function(){if(this.files){var e=this.files[0],t=new FileReader;t.readAsText(e,"UTF-8"),t.onload=function(e){var t=e.target.result;m(".EPlugEnxInput").val(t)}}}),m(".spanEditorBtnExportEnx").off("click").click(function(){i.ExportFile()}),m('[data-toggle="tooltip"]').tooltip(),m(".EplugGraphRightToggle").on("click",function(){i.toggleRightContainer(m(this).hasClass("left"))})},this.Init(e)}});