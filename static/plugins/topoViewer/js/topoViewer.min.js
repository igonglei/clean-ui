!function(e,t){"use strict";"function"==typeof define&&define.amd?define(["jquery"],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t(require("jquery")):e.topoViewer=t(e.jQuery)}(this,function(e){var t="undefined"!=typeof window?window.document:{},n={root:"static/plugins/topoViewer/",imageDir:"images/",background:"background.jpg",url:null,dataDir:"data/",data:"data.json",scale:1},r={template:function(t,n){if(!t||!n)return t;var r=/{(.*?)}/g,s=t.match(r);return e.each(s,function(e,s){var a=s.replace(r,"$1"),l=n[a];void 0!==l&&(t=t.replace(s,l))}),t},round:function(e,t,n){var r=Math.pow(10,t);return Math.round(e*r*(n?100:1))/r}},s={name:"topoViewer",props:{mxGraph:{cellsResizable:!1,cellsEditable:!1,edgeLabelsMovable:!1,allowDanglingEdges:!1},mxConsts:{DEFAULT_FONTFAMILY:"Helvetica,Arial",VERTEX_SELECTION_COLOR:"#FF0000",EDGE_SELECTION_COLOR:"#FF0000",VERTEX_SELECTION_STROKEWIDTH:2,EDGE_SELECTION_STROKEWIDTH:2},cellHighlightColor:"#00FF00",cellStyle:{snc:{name:"snc",img:"snc.png"},snc_error:{name:"snc_error",img:"snc_error.png"},router:{name:"router",img:"router.png"},router_error:{name:"router_error",img:"router_error.png"},fp:{name:"fp",img:"fp.png"},fp_error:{name:"fp_error",img:"fp_error.png"}},groupStyle:{circle:"circle",rectangle:"rectangle",cloud:"cloud"},linkStyle:{link:"link",link_error:"link_error"},deviceCategory:{snc:"Server",router:"Router",fp:"Switch"},lengend:[{name:"SNC",cls:"snc"},{name:"S-Router",cls:"router"},{name:"FP",cls:"fp"}],inspectStatus:[{cname:"致命",ename:"Fatal",cls:"fatal"},{cname:"严重",ename:"Serious",cls:"serious"},{cname:"一般",ename:"Commonly",cls:"commonly"}],inspectLevel:{fatal:0,serious:1,commonly:2},arrange:{grid:"grid",circle:"circle"}},init:function(n){e(t.body).addClass(this.name),this.initGraph(n)},initGraph:function(t){var n=t.options,r=t.dom,s=t.graph=new mxGraph(r),a=this.props;e.extend(s,a.mxGraph),e.extend(mxConstants,a.mxConsts),new mxRubberband(s),new mxCellTracker(s,a.cellHighlightColor),mxEvent.disableContextMenu(r),s.zoomTo(n.scale),this.initProps(t),this.setBackground(t),this.setLengend(t),this.setStatus(t),this.configureStylesheet(t),this.getTooltipForCell(s),this.getLabel(s),this.draw(t)},initProps:function(e){var t=e.graph,n=t.getModel(),r=e.options,s=r.root,l=s+r.imageDir;e.mxHelper=new a(n,t),e.sourceData={devices:[],links:[]},e.path={imgDir:l,background:l+r.background,data:s+r.dataDir+r.data}},setBackground:function(e){var t=e.path.background;e.$el.after(r.template('<img class="topo-bg" / src="{bg}">',{bg:t}))},getLabel:function(e){e.getLabel=function(e){return e.value&&e.value.label}},getTooltipForCell:function(t){var n=(this.props.groupStyle,function(t){var n="";return e.each(t.inspectResult,function(e,t){n+=r.template('<div class="col-xs-4 error">{name}</div><div class="col-xs-8 error">{msg}</div>',t)}),t.InspectMessage=n,t});t.setTooltips(!0),t.getTooltipForCell=function(e){var t=e.value;if(t){if(e.edge){if(t=n(t),!t.InspectMessage)return;var s='<div class="row topo-cell-tooltip">{InspectMessage}</div>';return r.template(s,t)}if(!e.group){t=n(t);var s='<div class="row topo-cell-tooltip"><div class="col-xs-4">名称</div><div class="col-xs-8">{Name}</div><div class="col-xs-4">IP</div><div class="col-xs-8">{IP}</div>{InspectMessage}</div>';return r.template(s,t)}}}},setLengend:function(t){var n=e('<ul class="topoLegend"></ul>').insertAfter(t.$el);e.each(this.props.lengend,function(e,t){n.append(r.template('<li class="{cls}"><span class="icon"></span><span class="text">{name}</span></li>',t))})},setStatus:function(t){var n=e('<div class="divStatus"></div>').insertAfter(t.$el),s=this.props.inspectStatus,a=this.props.inspectLevel;e.each(s,function(e,t){t.level=a[t.cls],n.append(r.template('<div class="status {cls}" data-level="{level}"><span class="text">{cname}/{ename}</span><span class="value">0</span></div>',t))})},configureStylesheet:function(t){var n=t.path.imgDir,r=this.props.cellStyle,s=this.props.linkStyle,a=this.props.groupStyle,l=t.graph.getStylesheet(),i=function(e){var t={};t[mxConstants.STYLE_SHAPE]=mxConstants.SHAPE_IMAGE,t[mxConstants.STYLE_IMAGE]=n+e.img,t[mxConstants.STYLE_VERTICAL_ALIGN]=mxConstants.ALIGN_TOP,t[mxConstants.STYLE_VERTICAL_LABEL_POSITION]=mxConstants.ALIGN_BOTTOM,l.putCellStyle(e.name,t)};e.each(r,function(e,t){i(t)});var o={};o[mxConstants.STYLE_STROKECOLOR]="rgba(0,155,77,0.5)",o[mxConstants.STYLE_STROKEWIDTH]=2,o[mxConstants.STYLE_FONTSTYLE]=3,o[mxConstants.STYLE_PERIMETER_SPACING]=2,o[mxConstants.STYLE_ENDARROW]="",l.putCellStyle(s.link,o);var c=e.extend({},o);c[mxConstants.STYLE_STROKECOLOR]="rgba(219,25,33,0.6)",l.putCellStyle(s.link_error,c);var u={};u[mxConstants.STYLE_FILLCOLOR]="rgba(255,255,255,0.1)",u[mxConstants.STYLE_FONTSIZE]=0,u[mxConstants.STYLE_FONTCOLOR]="#f6f7e3",u[mxConstants.STYLE_VERTICAL_ALIGN]=mxConstants.ALIGN_TOP,u[mxConstants.STYLE_ALIGN]=mxConstants.ALIGN_LEFT,u[mxConstants.STYLE_SPACING_LEFT]=10,u[mxConstants.STYLE_SPACING_RIGHT]=10,u[mxConstants.STYLE_SHAPE]=mxConstants.SHAPE_ELLIPSE,l.putCellStyle(a.circle,u);var p=e.extend({},u);p[mxConstants.STYLE_FONTSIZE]=20,p[mxConstants.STYLE_SHAPE]=mxConstants.SHAPE_RECTANGLE,l.putCellStyle(a.rectangle,p);var g=e.extend({},u);g[mxConstants.STYLE_FONTSIZE]=20,g[mxConstants.STYLE_SHAPE]=mxConstants.SHAPE_CLOUD,l.putCellStyle(a.cloud,g)},draw:function(t){var n=this,r=1;t.$el.showLoader();var s=function(a){e.ajax({method:a||"GET",url:t.options.url||t.path.data+"?ts="+(new Date).valueOf(),dataType:"json",success:function(e){var r=e&&e.devices;r&&0!=r.length&&(t.sourceData.devices=r,t.sourceData.links=e.links||[],n.resize(t))},complete:function(){t.$el.hideLoader()},error:function(e){if(405===e.status){if(0===r)return;r--,s("POST")}}})};s()},resize:function(e){var t=e.graph,n=t.getModel();t.removeCells(t.getDefaultParent().children),n.beginUpdate();try{this.insertDevice(e),this.insertLink(e)}finally{n.endUpdate(),this.collapseGroup(e),this.setCount(e),this.setInspectCount(e)}},insertDevice:function(t){var n=this,r=t.graph,s=t.sourceData.devices,a=t.$el.width();e.each(s,function(e,t){t.group?n.insertGroup(r,t,a):n.insertCell(r,t,a)})},insertCell:function(t,n,r){var s=n.x,a=n.cells.length;"center"===s&&(s=(r-a*n.width-n.margin*(a-1))/2),e.each(n.cells,function(e,r){t.insertVertex(null,null,r,r.x||s+n.margin*e,r.y||n.y,r.width||n.width,r.height||n.height,r.style||n.style)})},insertGroup:function(t,n,r){var s=this,a=n.x,l=n.cells.length,i=s.props.arrange;if("center"===a){var o=0;e.each(n.cells,function(e,t){o+=t.width||n.width}),a=(r-o-n.margin*(l-1))/2+(n.offset||0)*l}e.each(n.cells,function(r,l){void 0===l.collapse&&(l.collapse=n.collapse||!1);var o=l.arrange||n.arrange,c=t.insertVertex(null,null,l,l.x||a+n.margin*r,l.y||n.y,l.width||n.width,l.height||n.height,l.style||n.style);c.group=!0,e.each(l.cells,function(e,r){var a={X:r.x||l.cellX||n.cellX,Y:r.y||l.cellY||n.cellY};o===i.circle?a=s.getPointInCircle(e,l.cells.length,l.width||n.width):o===i.grid&&(a=s.getThePointFun(l.cellX||n.cellX,l.cellY||n.cellY,l.cellMargin||n.cellMargin,l.cellMargin||n.cellMargin,e,l.cellColumn||n.cellColumn)),t.insertVertex(c,null,r,a.X,a.Y,r.width||l.cellWidth||n.cellWidth,r.height||l.cellHeight||n.cellHeight,r.style||l.cellStyle||n.cellStyle)})})},insertLink:function(t){var n=this,r=t.sourceData.links,s=n.props.linkStyle.link;e.each(r,function(e,r){var a=n.getVertexById(t,r.DeviceRootID),l=n.getVertexById(t,r.PeerDeviceRootID);a&&l&&t.graph.insertEdge(null,null,r,a,l,r.style||s)})},getThePointFun:function(e,t,n,r,s,a){var l={},i=Math.floor(s/a);return l.X=(s-i*a)*n+e,l.Y=i*r+t,l},getPointInCircle:function(e,t,n){var r=n/t,s=2*Math.PI/n*r*e,a=n/2;return{X:a+Math.sin(s)*a,Y:a-Math.cos(s)*a}},collapseGroup:function(e){var t=e.mxHelper.getVertexs(!0,function(e){return e.value.collapse});e.graph.foldCells(!0,!0,t)},getVertexById:function(e,t){return e.mxHelper.getVertexs(!0,function(e){return e.value&&e.value.ID==t})[0]},setCount:function(t){var n=this,s=t.mxHelper.getVertexs(!0),a=this.props.deviceCategory.snc,l=this.props.deviceCategory.router,i=this.props.deviceCategory.fp,o=this.props.linkStyle.link_error,c=0,u=0,p=0,g=0,d=function(t){return e.grep(s,function(e,n){return e.value.Category===t}).length},h=function(e,t){return 0===e&&0===t?"0%":r.round(e/(e+t),1,!0)+"%"};e.each(t.sourceData.links,function(e,r){var s=n.getVertexById(t,r.DeviceRootID),d=n.getVertexById(t,r.PeerDeviceRootID);s&&d&&((s.value.Category===l&&d.value.Category===l||s.value.Category===l&&d.value.Category===a||s.value.Category===a&&d.value.Category===l)&&(r.style===o?u++:c++),(s.value.Category===l&&d.value.Category===i||s.value.Category===i&&d.value.Category===l)&&(r.style===o?g++:p++))}),e("#fpRegCount").text(d(a)),e("#routerCount").text(d(l)),e("#fpCount").text(d(i)),e("#routerLinked").text(c),e("#routerUnlinked").text(u),e("#routerRate").text(h(c,u)),e("#fpLinked").text(p),e("#fpUnlinked").text(g),e("#fpRate").text(h(p,g))},setInspectCount:function(t){var n=t.mxHelper.getCells(!0),r=e.map(e.grep(n,function(e){return e.value&&e.value.inspectResult}),function(e){return e.value.inspectResult}),s={fatal:0,serious:0,commonly:0},a=this.props.inspectLevel;e.each(r,function(e,t){t.level===a.fatal?s.fatal++:t.level===a.serious?s.serious++:s.commonly++}),e.each(a,function(t,n){e('.status[data-level="'+n+'"] .value').text(s[t])})}},a=function(t,n){var r={},s=function(n,r,a){var l=t.getChildVertices(n);l.length>0&&(e.merge(r,l),a&&e.each(l,function(e,t){s(t,r,a)}))},a=function(n,r,s){var l=t.getChildEdges(n);if(l.length>0&&(e.merge(r,l),s)){var i=t.getChildVertices(n);e.each(i,function(e,t){a(t,r,s)})}};return r.getVertexs=function(t,r){var a=n.getDefaultParent(),l=[];return s(a,l,t),r?e.grep(l,r):l},r.getEdges=function(t,r){var s=n.getDefaultParent(),l=[];return a(s,l,t),r?e.grep(l,r):l},r.getCells=function(t,n){var r=this.getVertexs(t).concat(this.getEdges(t));return n?e.grep(r,n):r},r},l=function(t,r){this.instanceId=s.name+(new Date).valueOf(),this.dom=t,this.$el=e(t),this.options=e.extend({},n,r),this.init()};return l.prototype={constructor:l,init:function(){s.init(this)},resize:function(){s.resize(this)}},e.fn.topoViewer=function(t,n){return"string"==typeof t?e.fn.topoViewer.methods[t](this[0],n):this.each(function(){var n=new l(this,t);return e.data(this,s.name,n),n})},e.fn.topoViewer.methods={instance:function(t){return e.data(t,s.name)},options:function(e){return this.instance(e).options},resize:function(e){return this.instance(e).resize()}},e.fn.topoViewer.defaults=n,l});